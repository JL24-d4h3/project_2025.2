<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Feedbacks - DevPortal</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/project-repository.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    
    <style>
        :root {
            --primary-color: #2596be;
            --primary-dark: #1e7a9a;
            --primary-light: #e3f2fd;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-light: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        .feedback-container {
            padding: 1.5rem;
            min-height: 100vh;
            background: #f8f9fa;
        }

        .feedback-main {
            max-width: 1400px;
            margin: 0 auto;
        }

        .feedback-header {
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left {
            flex: 1;
            min-width: 200px;
        }

        .breadcrumb {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: var(--primary-dark);
        }

        .page-title {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            color: white;
            text-decoration: none;
        }

        .feedback-tabs {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--border-light);
            padding: 0 1.5rem;
        }

        .nav-tabs .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 1rem 1.5rem;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            border-color: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            background: transparent;
        }

        .tab-content {
            padding: 1.5rem;
        }

        .feedback-card {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .feedback-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .feedback-header-card {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .feedback-title {
            flex: 1;
            min-width: 200px;
        }

        .feedback-title h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .meta-item i {
            width: 1rem;
            text-align: center;
            color: var(--primary-color);
        }

        .feedback-status {
            padding: 0.375rem 0.875rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .status-pendiente { background: #fff3e0; color: #f57c00; }
        .status-revisado { background: #e3f2fd; color: #1976d2; }
        .status-resuelto { background: #e8f5e8; color: #388e3c; }

        .feedback-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #ffa726;
            font-size: 1rem;
        }

        .feedback-rating i.filled {
            color: #ffa726;
        }

        .feedback-rating i.empty {
            color: #e0e0e0;
        }

        .feedback-comment {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .feedback-type {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .type-sugerencia { background: #e8f5e8; color: #388e3c; }
        .type-error { background: #ffebee; color: #d32f2f; }
        .type-mejora { background: #e3f2fd; color: #1976d2; }
        .type-pregunta { background: #f3e5f5; color: #7b1fa2; }
        .type-otro { background: #fafafa; color: #666; }

        .feedback-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-view {
            background: var(--primary-color);
            color: white;
        }

        .btn-view:hover {
            background: var(--primary-dark);
            color: white;
            text-decoration: none;
        }

        .btn-edit {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .btn-edit:hover {
            background: #7b1fa2;
            color: white;
        }

        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-delete:hover {
            background: #d32f2f;
            color: white;
        }

        .btn-review {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-review:hover {
            background: #1976d2;
            color: white;
        }

        .btn-resolve {
            background: #e8f5e8;
            color: #388e3c;
        }

        .btn-resolve:hover {
            background: #388e3c;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .empty-title {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .empty-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .feedback-container {
                padding: 1rem;
            }

            .feedback-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .page-title {
                font-size: 1.5rem;
                justify-content: center;
            }

            .feedback-header-card {
                flex-direction: column;
            }

            .feedback-actions {
                justify-content: stretch;
            }

            .btn-sm {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
<!-- Banner de impersonación si aplica -->
<div th:replace="~{fragments/impersonation-banner :: impersonation-banner}"></div>

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar(currentNavSection='feedback')}"></div>

<div class="feedback-container">
    <main class="feedback-main content-after-navbar">
        <!-- Header -->
        <div class="feedback-header">
            <div class="header-left">
                <div class="breadcrumb">
                    <a th:href="@{/devportal/{rol}/{username}/dashboard(rol=${rol}, username=${username})}">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <i class="fas fa-chevron-right"></i>
                    <a th:href="@{/devportal/{rol}/{username}/feedback(rol=${rol}, username=${username})}">
                        Feedbacks
                    </a>
                    <i class="fas fa-chevron-right"></i>
                    <span>Lista</span>
                </div>

                <h2 class="page-title">
                    <i class="fas fa-list" style="color: #2596be;"></i>
                    Mis Feedbacks
                </h2>
            </div>

            <div class="header-actions">
                <a th:href="@{/devportal/{rol}/{username}/feedback/create(rol=${rol}, username=${username})}"
                   class="btn-primary">
                    <i class="fas fa-plus"></i>
                    Nuevo Feedback
                </a>
            </div>
        </div>

        <!-- Tabs -->
        <div class="feedback-tabs">
            <ul class="nav nav-tabs" id="feedbackTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" 
                            th:classappend="${activeTab == 'sent' ? 'active' : ''}"
                            id="sent-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#sent-pane" 
                            type="button" 
                            role="tab">
                        <i class="fas fa-paper-plane"></i>
                        Mis Feedbacks
                        <span class="badge bg-primary ms-2" th:text="${#lists.size(myFeedbacks)}">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" 
                            th:classappend="${activeTab == 'received' ? 'active' : ''}"
                            id="received-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#received-pane" 
                            type="button" 
                            role="tab">
                        <i class="fas fa-inbox"></i>
                        Feedbacks Recibidos
                        <span class="badge bg-warning ms-2" th:text="${#lists.size(receivedFeedbacks)}">0</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="feedbackTabsContent">
                <!-- Tab: Mis Feedbacks (Enviados) -->
                <div class="tab-pane fade" 
                     th:classappend="${activeTab == 'sent' ? 'show active' : ''}"
                     id="sent-pane" 
                     role="tabpanel">
                    
                    <div th:if="${#lists.isEmpty(myFeedbacks)}" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <h3 class="empty-title">No has enviado feedbacks</h3>
                        <p class="empty-message">
                            Cuando envíes tu primer feedback, aparecerá aquí.
                        </p>
                        <a th:href="@{/devportal/{rol}/{username}/feedback/create(rol=${rol}, username=${username})}"
                           class="btn-primary">
                            <i class="fas fa-plus"></i>
                            Crear Feedback
                        </a>
                    </div>

                    <div th:if="${!#lists.isEmpty(myFeedbacks)}">
                        <div class="feedback-card" th:each="feedback : ${myFeedbacks}">
                            <div class="feedback-header-card">
                                <div class="feedback-title">
                                    <h4>
                                        <i class="fas fa-book" style="color: #2596be;"></i>
                                        <span th:text="${feedback.apiName}">API Name</span>
                                        <span style="color: var(--text-muted); font-weight: 400;">-</span>
                                        <span style="color: var(--text-secondary); font-weight: 400;" 
                                              th:text="${feedback.documentationSection}">Section</span>
                                    </h4>
                                    <div class="feedback-meta">
                                        <span class="meta-item">
                                            <i class="fas fa-calendar"></i>
                                            <span th:text="${#temporals.format(feedback.createdAt, 'dd/MM/yyyy HH:mm')}">28/10/2025 10:30</span>
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-hashtag"></i>
                                            <span>F-<span th:text="${feedback.feedbackId}">123</span></span>
                                        </span>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                    <span class="feedback-status" 
                                          th:classappend="${feedback.feedbackStatus.toString() == 'PENDIENTE' ? 'status-pendiente' : 
                                                          (feedback.feedbackStatus.toString() == 'REVISADO' ? 'status-revisado' : 'status-resuelto')}"
                                          th:text="${feedback.feedbackStatus.toString()}">PENDIENTE</span>
                                    <div class="feedback-rating">
                                        <i th:each="star : ${#numbers.sequence(1, 5)}" 
                                           th:classappend="${star <= feedback.rating ? 'fas fa-star filled' : 'far fa-star empty'}"></i>
                                    </div>
                                </div>
                            </div>

                            <span class="feedback-type" 
                                  th:classappend="${feedback.feedbackType.toString() == 'SUGERENCIA' ? 'type-sugerencia' : 
                                                  (feedback.feedbackType.toString() == 'ERROR' ? 'type-error' : 
                                                  (feedback.feedbackType.toString() == 'MEJORA' ? 'type-mejora' : 
                                                  (feedback.feedbackType.toString() == 'PREGUNTA' ? 'type-pregunta' : 'type-otro')))}"
                                  th:text="${feedback.feedbackType.toString()}">SUGERENCIA</span>

                            <p class="feedback-comment" th:text="${feedback.comment}">
                                Comentario del feedback...
                            </p>

                            <div class="feedback-actions">
                                <a th:href="@{/devportal/{rol}/{username}/feedback/F-{id}/detail(rol=${rol}, username=${username}, id=${feedback.feedbackId})}"
                                   class="btn-sm btn-view">
                                    <i class="fas fa-eye"></i>
                                    Ver Detalle
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Feedbacks Recibidos -->
                <div class="tab-pane fade" 
                     th:classappend="${activeTab == 'received' ? 'show active' : ''}"
                     id="received-pane" 
                     role="tabpanel">
                    
                    <div th:if="${#lists.isEmpty(receivedFeedbacks)}" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h3 class="empty-title">No has recibido feedbacks</h3>
                        <p class="empty-message">
                            Cuando recibas feedbacks sobre tus documentaciones, aparecerán aquí.
                        </p>
                    </div>

                    <div th:if="${!#lists.isEmpty(receivedFeedbacks)}">
                        <div class="feedback-card" th:each="feedback : ${receivedFeedbacks}">
                            <div class="feedback-header-card">
                                <div class="feedback-title">
                                    <h4>
                                        <i class="fas fa-book" style="color: #2596be;"></i>
                                        <span th:text="${feedback.apiName}">API Name</span>
                                        <span style="color: var(--text-muted); font-weight: 400;">-</span>
                                        <span style="color: var(--text-secondary); font-weight: 400;" 
                                              th:text="${feedback.documentationSection}">Section</span>
                                    </h4>
                                    <div class="feedback-meta">
                                        <span class="meta-item">
                                            <i class="fas fa-user"></i>
                                            <span th:text="${feedback.userFullName}">Usuario</span>
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-calendar"></i>
                                            <span th:text="${#temporals.format(feedback.createdAt, 'dd/MM/yyyy HH:mm')}">28/10/2025 10:30</span>
                                        </span>
                                        <span class="meta-item">
                                            <i class="fas fa-hashtag"></i>
                                            <span>F-<span th:text="${feedback.feedbackId}">123</span></span>
                                        </span>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
                                    <span class="feedback-status" 
                                          th:classappend="${feedback.feedbackStatus.toString() == 'PENDIENTE' ? 'status-pendiente' : 
                                                          (feedback.feedbackStatus.toString() == 'REVISADO' ? 'status-revisado' : 'status-resuelto')}"
                                          th:text="${feedback.feedbackStatus.toString()}">PENDIENTE</span>
                                    <div class="feedback-rating">
                                        <i th:each="star : ${#numbers.sequence(1, 5)}" 
                                           th:classappend="${star <= feedback.rating ? 'fas fa-star filled' : 'far fa-star empty'}"></i>
                                    </div>
                                </div>
                            </div>

                            <span class="feedback-type" 
                                  th:classappend="${feedback.feedbackType.toString() == 'SUGERENCIA' ? 'type-sugerencia' : 
                                                  (feedback.feedbackType.toString() == 'ERROR' ? 'type-error' : 
                                                  (feedback.feedbackType.toString() == 'MEJORA' ? 'type-mejora' : 
                                                  (feedback.feedbackType.toString() == 'PREGUNTA' ? 'type-pregunta' : 'type-otro')))}"
                                  th:text="${feedback.feedbackType.toString()}">SUGERENCIA</span>

                            <p class="feedback-comment" th:text="${feedback.comment}">
                                Comentario del feedback...
                            </p>

                            <div class="feedback-actions">
                                <a th:href="@{/devportal/{rol}/{username}/feedback/F-{id}/detail(rol=${rol}, username=${username}, id=${feedback.feedbackId})}"
                                   class="btn-sm btn-view">
                                    <i class="fas fa-eye"></i>
                                    Ver Detalle
                                </a>
                                <button th:if="${feedback.feedbackStatus.toString() == 'PENDIENTE'}"
                                        class="btn-sm btn-review" 
                                        onclick="markAsReviewed(this)"
                                        th:attr="data-feedback-id=${feedback.feedbackId}">
                                    <i class="fas fa-check"></i>
                                    Marcar Revisado
                                </button>
                                <button th:if="${feedback.feedbackStatus.toString() != 'RESUELTO'}"
                                        class="btn-sm btn-resolve" 
                                        onclick="markAsResolved(this)"
                                        th:attr="data-feedback-id=${feedback.feedbackId}">
                                    <i class="fas fa-check-double"></i>
                                    Marcar Resuelto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Feedback JS -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const rol = /*[[${rol}]]*/ 'dev';
    const username = /*[[${username}]]*/ 'usuario';

    async function markAsReviewed(button) {
        const feedbackId = button.getAttribute('data-feedback-id');
        
        if (!confirm('¿Marcar este feedback como revisado?')) {
            return;
        }

        try {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            const response = await fetch(`/devportal/${rol}/${username}/feedback/${feedbackId}/review`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('Feedback marcado como revisado exitosamente');
                location.reload();
            } else {
                alert('Error: ' + data.message);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i> Marcar Revisado';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Marcar Revisado';
        }
    }

    async function markAsResolved(button) {
        const feedbackId = button.getAttribute('data-feedback-id');
        
        if (!confirm('¿Marcar este feedback como resuelto?')) {
            return;
        }

        try {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            const response = await fetch(`/devportal/${rol}/${username}/feedback/${feedbackId}/resolve`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('Feedback marcado como resuelto exitosamente');
                location.reload();
            } else {
                alert('Error: ' + data.message);
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check-double"></i> Marcar Resuelto';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check-double"></i> Marcar Resuelto';
        }
    }
    /*]]>*/
</script>

<div th:replace="~{fragments/chatbot-widget :: chatbot-widget}"></div>

</body>
</html>





