<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyectos - DevPortal</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/project-repository.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" th:href="@{/img/favicon.ico}">
</head>
<body>
    <!-- Banner de Impersonaci√≥n -->
    <div th:replace="~{fragments/impersonation-banner :: impersonation-banner}"></div>

    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Header Section -->
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <!-- Breadcrumb simple -->
                    <div class="breadcrumb-simple mb-2">
                        <span class="text-primary">
                            <i class="fas fa-home"></i> Dashboard
                        </span>
                        <span class="mx-2">/</span>
                        <span>Proyectos</span>
                    </div>
                    <h1 class="header-title">
                        <i class="fas fa-folder me-2"></i>
                        Proyectos
                    </h1>
                </div>
                <div class="user-info">
                    <img th:src="${user.fotoPerfil != null ? user.fotoPerfil : '/img/default-avatar.png'}" 
                         alt="Avatar" class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%;">
                    <span th:text="${user.nombreUsuario}">Usuario</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Header -->
            <section class="dashboard-header">
                <div class="dashboard-title">
                    <h1>
                        <div class="icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        Mis Proyectos
                    </h1>
                    <div class="dropdown">
                        <button class="create-button dropdown-toggle" type="button" id="createProjectDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus"></i>
                            Nuevo Proyecto
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="createProjectDropdown">
                            <li>
                                <a class="dropdown-item" th:href="@{/devportal/{userRole}/{username}/projects/create/personal(userRole=${userRole}, username=${username})}">
                                    <i class="fas fa-user"></i>
                                    Proyecto Personal
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" th:href="@{/devportal/{userRole}/{username}/projects/create/group(userRole=${userRole}, username=${username})}">
                                    <i class="fas fa-users"></i>
                                    Proyecto de Grupo
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" th:href="@{/devportal/{userRole}/{username}/projects/create/enterprise(userRole=${userRole}, username=${username})}">
                                    <i class="fas fa-building"></i>
                                    Proyecto Empresarial
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <a th:href="@{/devportal/{userRole}/{username}/projects/personal-projects(userRole=${userRole}, username=${username})}"
                       class="stat-card" 
                       th:classappend="${currentSection == 'personal-projects' ? 'active' : ''}"
                       style="text-decoration: none; color: inherit;">
                        <div class="stat-value" th:text="${stats.personal_projects ?: 0}">0</div>
                        <div class="stat-label">Proyectos Personales</div>
                    </a>
                    <a th:href="@{/devportal/{userRole}/{username}/projects/team-projects(userRole=${userRole}, username=${username})}"
                       class="stat-card"
                       th:classappend="${currentSection == 'team-projects' ? 'active' : ''}"
                       style="text-decoration: none; color: inherit;">
                        <div class="stat-value" th:text="${stats.team_projects ?: 0}">0</div>
                        <div class="stat-label">Proyectos de Equipo</div>
                    </a>
                    <a th:href="@{/devportal/{userRole}/{username}/projects/i-am-part-of(userRole=${userRole}, username=${username})}"
                       class="stat-card"
                       th:classappend="${currentSection == 'i-am-part-of' ? 'active' : ''}"
                       style="text-decoration: none; color: inherit;">
                        <div class="stat-value" th:text="${stats.participating_projects ?: 0}">0</div>
                        <div class="stat-label">Donde Participo</div>
                    </a>
                    <a th:href="@{/devportal/{userRole}/{username}/projects/other-projects(userRole=${userRole}, username=${username})}"
                       class="stat-card"
                       th:classappend="${currentSection == 'other-projects' ? 'active' : ''}"
                       style="text-decoration: none; color: inherit;">
                        <div class="stat-value" th:text="${stats.other_projects ?: 0}">0</div>
                        <div class="stat-label">Otros Proyectos</div>
                    </a>
                </div>
            </section>
            
            <!-- Filters Section -->
            <section class="filters-section">
                <div class="filters-header">
                    <h3 class="filters-title">Filtros y B√∫squeda</h3>
                </div>
                
                <form class="filters-form" th:action="@{/devportal/{userRole}/{username}/projects(userRole=${userRole}, username=${username})}" method="get">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label class="form-label" for="search">Buscar proyectos</label>
                            <input type="text" 
                                   id="search" 
                                   name="search" 
                                   class="form-input search-input" 
                                   placeholder="Buscar por nombre o descripci√≥n..."
                                   th:value="${param.search}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="category">Categor√≠a</label>
                            <select id="category" name="category" class="form-select">
                                <option value="">Todas las categor√≠as</option>
                                <option th:each="categoria : ${categorias}" 
                                        th:value="${categoria.nombreCategoria}"
                                        th:text="${categoria.nombreCategoria}"
                                        th:selected="${param.category == categoria.nombreCategoria}">
                                    Categor√≠a
                                </option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="sort">Ordenar por</label>
                            <select id="sort" name="sort" class="form-select">
                                <option value="recent" th:selected="${param.sort == 'recent' or param.sort == null}">M√°s recientes</option>
                                <option value="name" th:selected="${param.sort == 'name'}">Nombre A-Z</option>
                                <option value="oldest" th:selected="${param.sort == 'oldest'}">M√°s antiguos</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="filter-button">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                    </div>
                </form>
            </section>
            
            <!-- Items Section -->
            <section class="items-section">
                <div class="items-header">
                    <h3 class="items-title">
                        <span class="title-text">
                            <span th:if="${currentSection == 'personal-projects'}">Proyectos Personales</span>
                            <span th:if="${currentSection == 'team-projects'}">Proyectos de Equipo</span>
                            <span th:if="${currentSection == 'i-am-part-of'}">Donde Participo</span>
                            <span th:if="${currentSection == 'other-projects'}">Otros Proyectos</span>
                            <span th:if="${currentSection == null or currentSection == ''}">Todos los Proyectos</span>
                        </span>
                        <span class="text-muted title-count">(<span th:text="${#lists.size(projects)}">0</span>)</span>
                    </h3>
                    
                    <div class="view-toggle">
                        <button type="button" class="active" data-view="grid">
                            <i class="fas fa-th"></i>
                        </button>
                        <button type="button" data-view="list">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Grid View -->
                <div class="items-grid" th:if="${#lists.size(projects) > 0}">
                    <div class="item-card"
                         th:each="proyecto : ${projects}"
                         th:data-id="${proyecto.proyecto_id}"
                         th:data-type="project">
                        
                        <div class="item-header">
                            <h4 class="item-title">
                                <div class="icon">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <span th:text="${proyecto.nombre_proyecto}">Nombre del proyecto</span>
                            </h4>
                            <p class="item-description" th:text="${proyecto.descripcion_proyecto ?: 'Sin descripci√≥n'}">
                                Descripci√≥n del proyecto
                            </p>
                        </div>
                        
                        <div class="item-meta">
                            <div class="item-info">
                                <span th:if="${proyecto.fecha_inicio_proyecto}">
                                    <i class="fas fa-calendar"></i>
                                    <span th:text="${#temporals.format(proyecto.fecha_inicio_proyecto, 'dd/MM/yyyy')}">01/01/2024</span>
                                </span>
                                <span th:if="${proyecto.nombre_categoria}">
                                    <i class="fas fa-tag"></i>
                                    <span th:text="${proyecto.nombre_categoria}">Categor√≠a</span>
                                </span>
                            </div>
                            
                            <div class="item-badges">
                                <span class="badge badge-public" th:if="${proyecto.visibilidad_proyecto == 'PUBLICO'}">
                                    P√∫blico
                                </span>
                                <span class="badge badge-private" th:if="${proyecto.visibilidad_proyecto == 'PRIVADO'}">
                                    Privado
                                </span>
                                <span class="badge badge-category" th:if="${proyecto.nombre_categoria}" th:text="${proyecto.nombre_categoria}">
                                    Categor√≠a
                                </span>
                            </div>
                        </div>
                        
                        <div class="item-actions">
                            <a th:href="@{/devportal/{userRole}/{username}/projects/P-{id}(userRole=${userRole}, username=${username}, id=${proyecto.proyecto_id})}"
                               class="action-button primary">
                                <i class="fas fa-eye"></i>
                                Ver
                            </a>
                            <a th:href="@{/devportal/{userRole}/{username}/projects/P-{id}/edit(userRole=${userRole}, username=${username}, id=${proyecto.proyecto_id})}"
                               class="action-button"
                               th:if="${proyecto.privilegio_usuario_actual == 'PROPIETARIO' or proyecto.privilegio_usuario_actual == 'ADMIN'}">
                                <i class="fas fa-edit"></i>
                                Editar
                            </a>
                            <button class="action-button" 
                                    data-action="clone" 
                                    th:data-id="${proyecto.proyecto_id}">
                                <i class="fas fa-clone"></i>
                                Clonar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- List View -->
                <div class="items-list" style="display: none;" th:if="${#lists.size(projects) > 0}">
                    <div class="item-row"
                         th:each="proyecto : ${projects}"
                         th:data-id="${proyecto.proyecto_id}"
                         th:data-type="project">
                        
                        <div class="row-info">
                            <div class="row-title" th:text="${proyecto.nombre_proyecto}">Nombre del proyecto</div>
                            <div class="row-description" th:text="${proyecto.descripcion_proyecto ?: 'Sin descripci√≥n'}">
                                Descripci√≥n del proyecto
                            </div>
                        </div>
                        
                        <div class="row-meta">
                            <span th:if="${proyecto.nombre_categoria}" th:text="${proyecto.nombre_categoria}">Categor√≠a</span>
                            <span class="badge badge-public" th:if="${proyecto.visibilidad_proyecto == 'PUBLICO'}">P√∫blico</span>
                            <span class="badge badge-private" th:if="${proyecto.visibilidad_proyecto == 'PRIVADO'}">Privado</span>
                        </div>
                        
                        <div class="row-meta">
                            <span th:if="${proyecto.fecha_inicio_proyecto}" th:text="${#temporals.format(proyecto.fecha_inicio_proyecto, 'dd/MM/yyyy')}">01/01/2024</span>
                        </div>
                        
                        <div class="row-actions">
                            <a th:href="@{/devportal/{userRole}/{username}/projects/P-{id}(userRole=${userRole}, username=${username}, id=${proyecto.proyecto_id})}" 
                               class="action-button primary">
                                Ver
                            </a>
                            <a th:href="@{/devportal/{userRole}/{username}/projects/P-{id}/edit(userRole=${userRole}, username=${username}, id=${proyecto.proyecto_id})}" 
                               class="action-button"
                               th:if="${proyecto.privilegio_usuario_actual == 'PROPIETARIO' or proyecto.privilegio_usuario_actual == 'ADMIN'}">
                                Editar
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" th:if="${#lists.isEmpty(projects)}">
                    <div class="empty-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <h3 class="empty-title">No se encontraron proyectos</h3>
                    <p class="empty-description">
                        <span th:if="${param.search}">No hay proyectos que coincidan con tu b√∫squeda.</span>
                        <span th:unless="${param.search}">Comienza creando tu primer proyecto.</span>
                    </p>
                    <div class="dropdown" th:unless="${param.search}">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="emptyCreateProjectDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus"></i>
                            Crear Proyecto
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="emptyCreateProjectDropdown">
                            <li>
                                <a class="dropdown-item" th:href="@{/devportal/{userRole}/{username}/projects/create/personal(userRole=${userRole}, username=${username})}">
                                    <i class="fas fa-user"></i>
                                    Proyecto Personal
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" th:href="@{/devportal/{userRole}/{username}/projects/create/group(userRole=${userRole}, username=${username})}">
                                    <i class="fas fa-users"></i>
                                    Proyecto de Grupo
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" th:href="@{/devportal/{userRole}/{username}/projects/create/enterprise(userRole=${userRole}, username=${username})}">
                                    <i class="fas fa-building"></i>
                                    Proyecto Empresarial
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>
        
    <!-- Create Project Modal -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Crear Nuevo Proyecto</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
                
                <form th:action="@{/devportal/{userRole}/{username}/projects/create(userRole=${userRole}, username=${username})}" method="post">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label" for="nombreProyecto">
                                Nombre del proyecto <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   id="nombreProyecto" 
                                   name="nombreProyecto" 
                                   class="form-control" 
                                   required 
                                   placeholder="Ingresa el nombre del proyecto">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="descripcionProyecto">Descripci√≥n</label>
                            <textarea id="descripcionProyecto" 
                                      name="descripcionProyecto" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Describe brevemente tu proyecto"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="categoriaId">Categor√≠a</label>
                                <select id="categoriaId" name="categoriaId" class="form-select">
                                    <option value="">Seleccionar categor√≠a</option>
                                    <option th:each="categoria : ${categorias}" 
                                            th:value="${categoria.idCategoria}"
                                            th:text="${categoria.nombreCategoria}">
                                        Categor√≠a
                                    </option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="visibilidadProyecto">Visibilidad</label>
                                <select id="visibilidadProyecto" name="visibilidadProyecto" class="form-select">
                                    <option value="PRIVADO">Privado</option>
                                    <option value="PUBLICO">P√∫blico</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="fechaFinProyecto">Fecha de finalizaci√≥n</label>
                                <input type="date"
                                       id="fechaFinProyecto"
                                       name="fechaFinProyecto"
                                       class="form-control">
                                <div class="form-text">
                                    Indica la fecha estimada o real de finalizaci√≥n del proyecto.
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="licenciaProyecto">Licencia</label>
                                <input type="text"
                                       id="licenciaProyecto"
                                       name="licenciaProyecto"
                                       class="form-control"
                                       placeholder="Ejemplo: MIT, GPL, Apache 2.0, etc.">
                                <div class="form-text">
                                    Especifica la licencia bajo la cual se distribuye el proyecto.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary btn-cancel">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Crear Proyecto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Additional CSS for dropdown -->
    <style>
        .dropdown .create-button {
            border: none;
            background: var(--primary-color);
            color: var(--white);
        }
        
        .dropdown .create-button:hover {
            background: var(--primary-dark);
        }
        
        .dropdown-menu {
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            padding: 0.5rem 0;
        }
        
        .dropdown-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--primary-color);
        }
        
        .dropdown-item i {
            width: 1.25rem;
            text-align: center;
        }
        
        /* Empty state dropdown styles */
        .empty-state .dropdown .btn {
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .empty-state .dropdown-menu {
            min-width: 200px;
        }
    </style>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/project-repository.js}"></script>
    
    <!-- ‚úÖ AJAX Navigation Script - Optimizaci√≥n de rendimiento -->
    <script th:inline="javascript">
    /*<![CDATA[*/
    (function() {
        'use strict';
        
        // Cache para proyectos con TTL de 5 minutos
        const projectCache = new Map();
        const CACHE_TTL = 5 * 60 * 1000; // 5 minutos
        const CACHE_MAX_SIZE = 50;
        
        // Variables de estado
        let isLoading = false;
        const userRole = /*[[${userRole}]]*/ 'dev';
        const username = /*[[${username}]]*/ 'username';
        
        /**
         * Limpia cache antiguo basado en TTL
         */
        function cleanOldCache() {
            const now = Date.now();
            for (const [key, value] of projectCache.entries()) {
                if (now - value.timestamp > CACHE_TTL) {
                    projectCache.delete(key);
                }
            }
            
            // Si cache es muy grande, eliminar entradas m√°s antiguas
            if (projectCache.size > CACHE_MAX_SIZE) {
                const entries = Array.from(projectCache.entries());
                entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
                const toDelete = entries.slice(0, projectCache.size - CACHE_MAX_SIZE);
                toDelete.forEach(([key]) => projectCache.delete(key));
            }
        }
        
        /**
         * Obtiene proyectos desde cache o API
         */
        async function fetchProjects(section, page = 0, category = '', search = '', sort = 'recent') {
            cleanOldCache();
            
            const cacheKey = `${section}-${page}-${category}-${search}-${sort}`;
            const cached = projectCache.get(cacheKey);
            
            if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
                console.log('‚úÖ Cache HIT:', cacheKey);
                return cached.data;
            }
            
            console.log('üîç Cache MISS, fetching from API:', cacheKey);
            
            const endpoint = `/api/projects/${section}`;
            const params = new URLSearchParams({
                page: page,
                category: category || '',
                search: search || '',
                sort: sort || 'recent'
            });
            
            const response = await fetch(`${endpoint}?${params}`);
            if (!response.ok) throw new Error('Error al cargar proyectos');
            
            const data = await response.json();
            
            // Guardar en cache
            projectCache.set(cacheKey, {
                data: data,
                timestamp: Date.now()
            });
            
            return data;
        }
        
        /**
         * Renderiza proyectos en el grid
         */
        function renderProjects(projects) {
            const grid = document.querySelector('.items-grid');
            if (!grid) return;
            
            if (projects.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>No se encontraron proyectos</p></div>';
                return;
            }
            
            grid.innerHTML = projects.map(project => `
                <div class="item-card" data-id="${project.proyecto_id}" data-type="project">
                    <div class="item-header">
                        <h4 class="item-title">
                            <div class="icon">
                                <i class="fas fa-folder"></i>
                            </div>
                            <span>${project.nombre_proyecto}</span>
                        </h4>
                        <p class="item-description">${project.descripcion_proyecto || 'Sin descripci√≥n'}</p>
                    </div>
                    
                    <div class="item-meta">
                        <div class="item-info">
                            ${project.fecha_inicio_proyecto ? `
                                <span>
                                    <i class="fas fa-calendar"></i>
                                    <span>${new Date(project.fecha_inicio_proyecto).toLocaleDateString('es-ES')}</span>
                                </span>
                            ` : ''}
                            ${project.nombre_categoria ? `
                                <span>
                                    <i class="fas fa-tag"></i>
                                    <span>${project.nombre_categoria}</span>
                                </span>
                            ` : ''}
                        </div>
                        
                        <div class="item-badges">
                            ${project.visibilidad_proyecto === 'PUBLICO' ? '<span class="badge badge-public">P√∫blico</span>' : ''}
                            ${project.visibilidad_proyecto === 'PRIVADO' ? '<span class="badge badge-private">Privado</span>' : ''}
                            ${project.nombre_categoria ? `<span class="badge badge-category">${project.nombre_categoria}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="item-actions">
                        <a href="/devportal/${userRole}/${username}/projects/P-${project.proyecto_id}" class="action-button primary">
                            <i class="fas fa-eye"></i>
                            Ver
                        </a>
                    </div>
                </div>
            `).join('');
        }
        
        /**
         * Actualiza UI con nuevos datos
         */
        function updateUI(data, apiSection) {
            renderProjects(data.projects);
            
            // Actualizar t√≠tulo
            const titleMap = {
                'personal': 'Proyectos Personales',
                'team': 'Proyectos de Equipo',
                'all': 'Donde Participo',
                'other': 'Otros Proyectos'
            };
            const titleElement = document.querySelector('.items-title');
            if (titleElement) {
                titleElement.innerHTML = `${titleMap[apiSection] || 'Proyectos'} <span class="text-muted">(${data.totalProjects})</span>`;
            }
            
            // Actualizar stat-cards active state
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            const activeCard = document.querySelector(`.stat-card[data-api-section="${apiSection}"]`);
            if (activeCard) activeCard.classList.add('active');
            
            // ‚úÖ Actualizar contadores de stat-cards din√°micamente
            const statCardsMap = [
                { section: 'personal', value: data.stats?.personal_projects || 0 },
                { section: 'team', value: data.stats?.team_projects || 0 },
                { section: 'all', value: data.stats?.i_am_part_of || 0 },
                { section: 'other', value: data.stats?.other_projects || 0 }
            ];
            
            document.querySelectorAll('.stat-card').forEach((card, index) => {
                const valueElement = card.querySelector('.stat-value');
                if (valueElement && statCardsMap[index]) {
                    valueElement.textContent = statCardsMap[index].value;
                }
            });
            
            // ‚úÖ PAGINACI√ìN: Ocultar si hay 12 o menos items
            const paginationControls = document.querySelector('.pagination-controls');
            if (paginationControls) {
                if (data.totalProjects <= 12) {
                    paginationControls.style.display = 'none';
                } else {
                    paginationControls.style.display = 'flex';
                    // Actualizar contadores de paginaci√≥n
                    const startSpan = paginationControls.querySelector('strong:nth-of-type(1)');
                    const endSpan = paginationControls.querySelector('strong:nth-of-type(2)');
                    const totalSpan = paginationControls.querySelector('strong:nth-of-type(3)');
                    const currentPageSpan = paginationControls.querySelector('span strong:nth-of-type(1)');
                    const totalPagesSpan = paginationControls.querySelector('span strong:nth-of-type(2)');
                    
                    if (startSpan) startSpan.textContent = data.startIndex || 1;
                    if (endSpan) endSpan.textContent = data.endIndex || data.totalProjects;
                    if (totalSpan) totalSpan.textContent = data.totalProjects;
                    if (currentPageSpan) currentPageSpan.textContent = (data.currentPage || 0) + 1;
                    if (totalPagesSpan) totalPagesSpan.textContent = data.totalPages || 1;
                }
            }
        }
        
        /**
         * Navegar a secci√≥n espec√≠fica
         */
        async function navigateToSection(apiSection, urlSection, updateHistory = true) {
            if (isLoading) return;
            
            isLoading = true;
            
            try {
                const category = document.getElementById('category')?.value || '';
                const search = document.getElementById('search')?.value || '';
                const sort = document.getElementById('sort')?.value || 'recent';
                
                const data = await fetchProjects(apiSection, 0, category, search, sort);
                updateUI(data, apiSection);
                
                if (updateHistory) {
                    const url = `/devportal/${userRole}/${username}/projects/${urlSection}`;
                    history.pushState({ apiSection, urlSection, page: 0 }, '', url);
                }
            } catch (error) {
                console.error('Error al navegar:', error);
            } finally {
                isLoading = false;
            }
        }
        
        // Interceptar clics en stat-cards
        document.querySelectorAll('.stat-card').forEach((card, index) => {
            // Mapeo correcto de secciones a endpoints API
            const sectionMap = [
                { url: 'personal-projects', api: 'personal' },
                { url: 'team-projects', api: 'team' },
                { url: 'i-am-part-of', api: 'all' }, // ‚úÖ "Donde participo" usa endpoint /api/projects/all
                { url: 'other-projects', api: 'other' }
            ];
            
            const section = sectionMap[index];
            card.dataset.section = section.url;
            card.dataset.apiSection = section.api;
            
            card.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToSection(section.api, section.url);
            });
        });
        
        // Interceptar submit del formulario de filtros
        const filterForm = document.querySelector('.filters-form');
        if (filterForm) {
            filterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const activeCard = document.querySelector('.stat-card.active');
                const apiSection = activeCard?.dataset.apiSection || 'personal';
                const urlSection = activeCard?.dataset.section || 'personal-projects';
                await navigateToSection(apiSection, urlSection, false);
            });
        }
        
        // Manejar bot√≥n atr√°s/adelante del navegador
        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.apiSection) {
                navigateToSection(e.state.apiSection, e.state.urlSection, false);
            }
        });
        
        console.log('‚úÖ AJAX Navigation initialized for projects dashboard');
    })();
    /*]]>*/
    </script>
    
    <!-- Chatbot Widget -->
    <div th:replace="~{fragments/chatbot-widget :: chatbot-widget}"></div>

</body>
</html>




