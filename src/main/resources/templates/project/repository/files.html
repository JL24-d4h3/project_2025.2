<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${'Contenido - ' + repositorio.nombreRepositorio}">Contenido - Repositorio</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/project-repository.css}">
    
    <style>
        :root {
            --primary-color: #2596be;
            --primary-dark: #1e7a9a;
            --primary-light: #e3f2fd;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-light: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        .files-container {
            padding: 1.5rem;
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .files-header {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }
        
        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb-item a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            color: var(--text-muted);
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary-action {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary-action:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary-action {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary-action:hover {
            background: #5a6268;
        }
        
        .btn-danger-action {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger-action:hover {
            background: #c82333;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }
        
        .search-box i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .files-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--border-light);
        }
        
        .files-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .files-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid var(--border-light);
        }
        
        .files-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .files-table tbody tr {
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .files-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .files-table tbody tr.selected {
            background-color: #e3f2fd !important;
        }
        
        .files-table tbody tr.cut-item {
            opacity: 0.5;
            background-color: #fff3cd !important;
        }
        
        .files-table tbody tr:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }
        
        /* Men√∫ contextual */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0.5rem 0;
            min-width: 200px;
            z-index: 9999;
            display: none;
        }
        
        .context-menu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: background-color 0.2s;
        }
        
        .context-menu-item:hover {
            background-color: var(--primary-light);
        }
        
        .context-menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .context-menu-item.disabled:hover {
            background-color: transparent;
        }
        
        .context-menu-separator {
            height: 1px;
            background-color: var(--border-light);
            margin: 0.5rem 0;
        }
        
        .context-menu-item i {
            width: 16px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .context-menu-item .shortcut {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Toast notifications */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid var(--primary-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 1rem 1.5rem;
            min-width: 300px;
            max-width: 400px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-notification.success {
            border-left-color: #28a745;
        }
        
        .toast-notification.error {
            border-left-color: #dc3545;
        }
        
        .toast-notification.warning {
            border-left-color: #ffc107;
        }
        
        .toast-notification.info {
            border-left-color: #17a2b8;
        }
        
        .files-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .files-table tbody tr.selected {
            background-color: var(--primary-light);
        }
        
        .files-table td {
            padding: 0.875rem 1rem;
            font-size: 0.9rem;
        }
        
        .file-name-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .file-icon {
            font-size: 1.5rem;
            width: 2rem;
            text-align: center;
        }
        
        .file-icon.folder {
            color: #FFA500;
        }
        
        .file-icon.file {
            color: #64B5F6;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* üÜï GITHUB-STYLE: Links en nombres de archivos/carpetas */
        .file-name-link {
            color: inherit; /* Heredar color del texto normal (negro) */
            text-decoration: none; /* Sin subrayado */
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .file-name-link:hover {
            color: var(--primary-color); /* Solo cambiar color al hover */
            text-decoration: none; /* Mantener sin subrayado */
        }
        
        .file-name-link:visited {
            color: inherit; /* No cambiar color en links visitados */
        }
        
        .file-size {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .file-date {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .files-table tbody tr:hover .file-actions {
            opacity: 1;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }
        
        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .context-menu-item i {
            width: 1.25rem;
        }
        
        .modal-backdrop.show {
            opacity: 0.5;
        }
        
        /* FIX: Asegurar que el modal se muestre correctamente */
        .modal {
            z-index: 1055 !important;
            display: block !important; /* Forzar display cuando tenga clase .show */
        }
        
        .modal.fade.show {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
        
        .modal-dialog {
            z-index: 1060 !important;
            margin: 1.75rem auto !important;
            transform: none !important;
        }
        
        .modal.show .modal-dialog {
            transform: translate(0, 0) !important;
        }
        
        /* Fila cortada (clipboard cut) */
        .files-table tbody tr.cut-item {
            opacity: 0.5;
            background-color: #fff3cd;
        }
        
        .files-table tbody tr.cut-item .file-name-cell {
            text-decoration: line-through;
        }
        
        /* Selecci√≥n activa */
        .files-table tbody tr.table-active {
            background-color: #cfe2ff !important;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="files-container">
        <!-- Header con breadcrumbs -->
        <div class="files-header">
            <!-- Breadcrumbs con selector de ramas -->
            <nav class="breadcrumb-nav" id="breadcrumbNav">
                <!-- Breadcrumbs del servidor (Thymeleaf) -->
                <th:block th:each="crumb, iterStat : ${breadcrumbs}">
                    <!-- Breadcrumb normal (no es rama) -->
                    <th:block th:unless="${crumb.isBranch}">
                        <div class="breadcrumb-item">
                            <a th:if="${!crumb.isActive}" th:href="${crumb.url}">
                                <span th:text="${crumb.nombre}">Nombre</span>
                            </a>
                            <span th:if="${crumb.isActive}" style="color: var(--text-primary); font-weight: 500;" th:text="${crumb.nombre}">Nombre</span>
                        </div>
                        <span class="breadcrumb-separator" th:unless="${crumb.isActive}">/</span>
                    </th:block>
                    
                    <!-- Breadcrumb especial para selector de ramas -->
                    <th:block th:if="${crumb.isBranch}">
                        <div class="breadcrumb-item dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle d-flex align-items-center gap-2" 
                                    type="button" 
                                    id="branchDropdown" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    style="border-radius: 6px; padding: 0.25rem 0.75rem;">
                                <i class="bi bi-git" style="font-size: 1rem;"></i>
                                <span th:text="${crumb.nombre}" th:if="${ramaActual != null}" style="font-weight: 500;">main</span>
                                <span th:text="${crumb.nombre}" th:unless="${ramaActual != null}" style="font-weight: 500;">rama</span>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="branchDropdown" th:if="${ramas != null}">
                                <li th:each="rama : ${ramas}">
                                    <a class="dropdown-item d-flex align-items-center gap-2" 
                                       th:href="@{/devportal/{rol}/{username}/projects/P-{projectId}/repositories/R-{repoId}/tree/{branch}(
                                           rol=${rol}, 
                                           username=${username}, 
                                           projectId=${proyecto.proyectoId},
                                           repoId=${repositorio.repositorioId}, 
                                           branch=${rama.nombreRama})}"
                                       th:classappend="${ramaActual != null && ramaActual.nombreRama == rama.nombreRama} ? 'active' : ''">
                                        <i class="bi bi-git" th:classappend="${rama.isPrincipal} ? 'text-primary' : ''"></i>
                                        <span th:text="${rama.nombreRama}">develop</span>
                                        <span th:if="${rama.isPrincipal}" class="badge bg-primary ms-auto" style="font-size: 0.65rem;">principal</span>
                                        <span th:if="${rama.isProtegida && !rama.isPrincipal}" class="badge bg-warning ms-auto" style="font-size: 0.65rem;">protegida</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <span class="breadcrumb-separator" th:unless="${crumb.isActive}">/</span>
                    </th:block>
                </th:block>
            </nav>
            
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Buscar archivos y carpetas..." />
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="toolbar-actions">
                    <button class="btn-action btn-primary-action" data-bs-toggle="modal" data-bs-target="#createFileModal" th:if="${canEdit}">
                        <i class="fas fa-file-medical"></i>
                        Nuevo archivo
                    </button>
                    <button class="btn-action btn-primary-action" data-bs-toggle="modal" data-bs-target="#createFolderModal" th:if="${canEdit}">
                        <i class="fas fa-folder-plus"></i>
                        Nueva carpeta
                    </button>
                    <button class="btn-action btn-primary-action" data-bs-toggle="modal" data-bs-target="#uploadFileModal" th:if="${canEdit}">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Subir archivo
                    </button>
                    <button class="btn-action btn-primary-action" data-bs-toggle="modal" data-bs-target="#uploadFolderModal" th:if="${canEdit}">
                        <i class="fas fa-folder-open"></i>
                        Subir carpeta
                    </button>
                    <button class="btn-action btn-secondary-action" id="btnDownload" style="display: none;">
                        <i class="fas fa-download"></i>
                        Descargar
                    </button>
                    <button class="btn-action btn-danger-action" id="btnDelete" style="display: none;" th:if="${canEdit}">
                        <i class="fas fa-trash"></i>
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Contenido de archivos -->
        <div class="files-content">
            <!-- Estado vac√≠o -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-folder-open"></i>
                <h5>Esta carpeta est√° vac√≠a</h5>
                <p>Arrastra archivos aqu√≠ o usa los botones de arriba para comenzar</p>
            </div>
            
            <!-- Tabla de archivos -->
            <table class="files-table" id="filesTable">
                <thead>
                    <tr>
                        <th style="width: 50px; display: none;">
                            <input type="checkbox" id="selectAll" />
                        </th>
                        <th>Nombre</th>
                        <th style="width: 120px;">Tama√±o</th>
                        <th style="width: 180px;">√öltima modificaci√≥n</th>
                        <th style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="filesList">
                    <!-- Se llena din√°micamente v√≠a JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal: Crear Carpeta -->
    <div class="modal fade" id="createFolderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-plus text-primary"></i>
                        Nueva carpeta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createFolderForm" onsubmit="event.preventDefault(); createFolder();">
                        <div class="mb-3">
                            <label for="folderName" class="form-label">Nombre de la carpeta</label>
                            <input type="text" class="form-control" id="folderName" required 
                                   placeholder="Ej: Documentos" maxlength="255" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createFolder()">
                        <i class="fas fa-check"></i> Crear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Nuevo Archivo -->
    <div class="modal fade" id="createFileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-medical text-primary"></i>
                        Nuevo archivo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createFileForm" onsubmit="event.preventDefault(); createFile();">
                        <div class="mb-3">
                            <label for="fileName" class="form-label">Nombre del archivo</label>
                            <input type="text" class="form-control" id="fileName" required 
                                   placeholder="Ej: documento.txt, script.js" maxlength="255" />
                            <div class="form-text">Incluye la extensi√≥n del archivo (.txt, .js, .md, etc.)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createFile()">
                        <i class="fas fa-check"></i> Crear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Subir Archivo -->
    <div class="modal fade" id="uploadFileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cloud-upload-alt text-primary"></i>
                        Subir archivo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadFileForm">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Seleccionar archivos</label>
                            <input type="file" class="form-control" id="fileInput" multiple required />
                            <small class="text-muted">Tama√±o m√°ximo: 100MB por archivo</small>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-2" id="uploadStatus"></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="uploadFiles()">
                        <i class="fas fa-upload"></i> Subir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Subir Carpeta -->
    <div class="modal fade" id="uploadFolderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-open text-primary"></i>
                        Subir carpeta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadFolderForm">
                        <div class="mb-3">
                            <label for="folderInput" class="form-label">Seleccionar carpeta</label>
                            <input type="file" class="form-control" id="folderInput" webkitdirectory directory multiple required />
                            <small class="text-muted">Se subir√° toda la estructura de la carpeta</small>
                        </div>
                        <div id="uploadFolderProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-2" id="uploadFolderStatus"></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="uploadFolder()">
                        <i class="fas fa-upload"></i> Subir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Renombrar -->
    <div class="modal fade" id="renameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit text-primary"></i>
                        Renombrar
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="renameForm">
                        <input type="hidden" id="renameNodoId" />
                        <div class="mb-3">
                            <label for="newName" class="form-label">Nuevo nombre</label>
                            <input type="text" class="form-control" id="newName" required maxlength="255" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="renameItem()">
                        <i class="fas fa-check"></i> Renombrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Men√∫ Contextual Completo -->
    <div id="contextMenu" class="context-menu">
        <!-- Selection-specific items (shown only when clicking on files) -->
        <div class="context-menu-item context-on-selection" onclick="copyToClipboard()">
            <i class="fas fa-copy"></i>
            <span>Copiar</span>
            <span class="shortcut">Ctrl+C</span>
        </div>
        <div class="context-menu-item context-on-selection" onclick="cutToClipboard()">
            <i class="fas fa-cut"></i>
            <span>Cortar</span>
            <span class="shortcut">Ctrl+X</span>
        </div>
        <div class="context-menu-divider context-on-selection"></div>
        <div class="context-menu-item context-on-selection" id="contextRename" onclick="contextMenuRename()">
            <i class="fas fa-edit"></i>
            <span>Renombrar</span>
            <span class="shortcut">F2</span>
        </div>
        <div class="context-menu-item context-on-selection" onclick="contextMenuDownload()">
            <i class="fas fa-download"></i>
            <span>Descargar</span>
            <span class="shortcut">Ctrl+D</span>
        </div>
        <div class="context-menu-item context-on-selection" onclick="deleteSelected()">
            <i class="fas fa-trash text-danger"></i>
            <span>Eliminar</span>
            <span class="shortcut">Supr</span>
        </div>
        
        <!-- Empty-space items (shown only when clicking outside files) -->
        <div class="context-menu-item context-on-empty" onclick="openCreateFileModal()">
            <i class="fas fa-file-medical"></i>
            <span>Nuevo archivo</span>
            <span class="shortcut">Alt+N</span>
        </div>
        <div class="context-menu-item context-on-empty" onclick="openCreateFolderModal()">
            <i class="fas fa-folder-plus"></i>
            <span>Nueva carpeta</span>
            <span class="shortcut">Alt+Shift+N</span>
        </div>
        <div class="context-menu-divider context-on-empty"></div>
        <div class="context-menu-item context-on-empty" onclick="openUploadFileModal()">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Subir archivo</span>
            <span class="shortcut">Alt+U</span>
        </div>
        <div class="context-menu-item context-on-empty" onclick="openUploadFolderModal()">
            <i class="fas fa-folder-open"></i>
            <span>Subir carpeta</span>
            <span class="shortcut">Alt+Shift+U</span>
        </div>
        
        <!-- Always visible items -->
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="contextPaste" onclick="pasteFromClipboard()">
            <i class="fas fa-paste"></i>
            <span>Pegar</span>
            <span class="shortcut">Ctrl+V</span>
        </div>
        <div class="context-menu-item" onclick="selectAll()">
            <i class="fas fa-check-double"></i>
            <span>Seleccionar todo</span>
            <span class="shortcut">Ctrl+A</span>
        </div>
        <div class="context-menu-item context-on-selection" onclick="contextMenuProperties()">
            <i class="fas fa-info-circle"></i>
            <span>Propiedades</span>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript del File System -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const REPOSITORIO_ID = /*[[${repositorio.repositorioId}]]*/ 0;
        const PROYECTO_ID = /*[[${proyecto != null ? proyecto.proyectoId : null}]]*/ null;
        const RAMA_ACTUAL = /*[[${ramaActual.nombreRama}]]*/ 'main';
        const ROL = /*[[${rol}]]*/ 'po';
        const USERNAME = /*[[${username}]]*/ 'user';
        const CAN_EDIT = /*[[${canEdit}]]*/ false;
        const CURRENT_NODE_ID = /*[[${currentNode != null ? currentNode.nodoId : null}]]*/ null;
        
        // üÜï GITHUB-STYLE: Nodos precargados del servidor (evita llamada API inicial)
        const PRELOADED_NODES = /*[[${nodos}]]*/ [];
        
        let currentPath = '/';
        let currentParentId = null;
        let selectedItems = [];
        let filesData = []; // üî• Variable global para almacenar datos de archivos
        
        // ‚ö° OPTIMIZACIONES DE RENDIMIENTO
        const CACHE_TTL = 5 * 60 * 1000; // 5 minutos
        const CACHE_MAX_SIZE = 50; // M√°ximo 50 carpetas en cach√©
        const folderCache = new Map(); // Cache de carpetas: {cacheKey: {data, timestamp}}
        const breadcrumbCache = new Map(); // Cache de breadcrumbs: {nodoId: {path, timestamp}}
        let isNavigating = false; // Flag para debouncing de navegaci√≥n
        let isBreadcrumbUpdating = false; // Flag para debouncing de breadcrumbs
        
        // Cargar contenido inicial
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [INIT] P√°gina cargada, inicializando...');
            console.log('üè∑Ô∏è [INIT] Repositorio ID:', REPOSITORIO_ID);
            console.log('üë§ [INIT] Usuario:', USERNAME, '| Rol:', ROL);
            console.log('‚úèÔ∏è [INIT] Puede editar:', CAN_EDIT);
            console.log('üìÇ [INIT] Current Node ID:', CURRENT_NODE_ID);
            console.log('üì¶ [INIT] Nodos precargados:', PRELOADED_NODES ? PRELOADED_NODES.length : 0);
            
            // üÜï GITHUB-STYLE: Renderizar nodos precargados del servidor (sin llamada API)
            if (PRELOADED_NODES && PRELOADED_NODES.length > 0) {
                console.log('‚úÖ [INIT] Usando nodos precargados del servidor');
                renderFiles(PRELOADED_NODES);
            } else {
                console.log('‚ö†Ô∏è [INIT] No hay nodos precargados, carpeta vac√≠a');
                renderFiles([]);
            }
            
            // üîÑ IMPORTANTE: Siempre actualizar currentParentId, incluso en carpetas vac√≠as
            currentParentId = CURRENT_NODE_ID;
            console.log('üîñ [INIT] currentParentId actualizado:', currentParentId);
            
            checkClipboardStatus(); // Verificar estado del portapapeles al cargar
            
            // Event listeners para modales (debugging)
            const createFolderModal = document.getElementById('createFolderModal');
            if (createFolderModal) {
                createFolderModal.addEventListener('show.bs.modal', function() {
                    console.log('üö™ [MODAL] Abriendo modal de crear carpeta...');
                });
                
                createFolderModal.addEventListener('shown.bs.modal', function() {
                    console.log('‚úÖ [MODAL] Modal de crear carpeta VISIBLE');
                    // Auto-focus en el input
                    document.getElementById('folderName').focus();
                });
                
                createFolderModal.addEventListener('hide.bs.modal', function() {
                    console.log('üö™ [MODAL] Cerrando modal de crear carpeta...');
                });
                
                createFolderModal.addEventListener('hidden.bs.modal', function() {
                    console.log('‚úÖ [MODAL] Modal de crear carpeta CERRADO');
                });
                
                // WORKAROUND: Forzar visibilidad despu√©s de 100ms si no aparece
                createFolderModal.addEventListener('show.bs.modal', function() {
                    setTimeout(() => {
                        const modalDialog = createFolderModal.querySelector('.modal-dialog');
                        const computedStyle = window.getComputedStyle(createFolderModal);
                        
                        console.log('üîç [MODAL-DEBUG] Estado actual:');
                        console.log('   - Display:', computedStyle.display);
                        console.log('   - Opacity:', computedStyle.opacity);
                        console.log('   - Visibility:', computedStyle.visibility);
                        console.log('   - Z-index:', computedStyle.zIndex);
                        console.log('   - Classes:', createFolderModal.className);
                        console.log('   - Tiene .show?:', createFolderModal.classList.contains('show'));
                        
                        if (modalDialog) {
                            const dialogStyle = window.getComputedStyle(modalDialog);
                            console.log('   - Dialog transform:', dialogStyle.transform);
                            console.log('   - Dialog display:', dialogStyle.display);
                        }
                        
                        // Si no tiene la clase 'show', hay un problema
                        if (!createFolderModal.classList.contains('show')) {
                            console.error('‚ùå [MODAL] No tiene clase .show despu√©s de 100ms - Forzando...');
                            createFolderModal.classList.add('show');
                            createFolderModal.style.display = 'block';
                            createFolderModal.style.paddingRight = '17px';
                            
                            // Agregar backdrop si no existe
                            if (!document.querySelector('.modal-backdrop')) {
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                document.body.appendChild(backdrop);
                            }
                        }
                    }, 100);
                });
            } else {
                console.error('‚ùå [MODAL] No se encontr√≥ el elemento createFolderModal');
            }
        });
        
        // ‚≠ê NUEVA FUNCI√ìN: Navegaci√≥n AJAX con History API (sin recargar p√°gina)
        function navigateToFolder(nodoId, fullPath, nombre) {
            // ‚ö° OPTIMIZACI√ìN: Debouncing - evitar m√∫ltiples clics
            if (isNavigating) {
                console.log('‚è∏Ô∏è [DEBOUNCE] Ya navegando, ignorando clic');
                return;
            }
            isNavigating = true;
            
            console.log('üõ£Ô∏è [AJAX-NAV] Navegando a carpeta:', { nodoId, fullPath, nombre });
            
            // 1. Construir nueva URL (GitHub-style)
            const newUrl = PROYECTO_ID 
                ? `/devportal/${ROL}/${USERNAME}/projects/P-${PROYECTO_ID}/repositories/R-${REPOSITORIO_ID}/tree/${RAMA_ACTUAL}/${fullPath}`
                : `/devportal/${ROL}/${USERNAME}/repositories/R-${REPOSITORIO_ID}/tree/${RAMA_ACTUAL}/${fullPath}`;
            
            // 2. Actualizar URL en navegador SIN recargar p√°gina
            history.pushState(
                { nodoId, fullPath, nombre, type: 'folder' }, 
                `${nombre} - TelDev`, 
                newUrl
            );
            console.log('‚úÖ [HISTORY] URL actualizada:', newUrl);
            
            // 3. Mostrar loading (opcional)
            showLoadingSkeleton();
            
            // 4. Cargar archivos via AJAX
            loadFiles(nodoId);
            
            // Liberar lock despu√©s de un tiempo (fallback por si falla)
            setTimeout(() => {
                isNavigating = false;
            }, 500);
        }
        
        // Manejar bot√≥n atr√°s/adelante del navegador
        window.addEventListener('popstate', (event) => {
            console.log('‚è™ [POPSTATE] Usuario us√≥ bot√≥n atr√°s/adelante', event.state);
            
            if (event.state && event.state.type === 'folder') {
                // Cargar carpeta desde historial (breadcrumbs se actualizar√°n en loadFiles)
                loadFiles(event.state.nodoId);
            } else {
                // Si no hay estado, recargar p√°gina (fallback)
                console.warn('‚ö†Ô∏è [POPSTATE] Sin estado - recargando p√°gina');
                window.location.reload();
            }
        });
        
        // Cargar archivos de una carpeta
        function loadFiles(parentId) {
            const cacheKey = `${REPOSITORIO_ID}_${parentId || 'root'}`;
            
            // ‚ö° OPTIMIZACI√ìN 1: Verificar cach√© primero
            if (folderCache.has(cacheKey)) {
                const cached = folderCache.get(cacheKey);
                const age = Date.now() - cached.timestamp;
                
                if (age < CACHE_TTL) {
                    console.log('‚ö° [CACHE HIT] Usando datos cacheados (edad: ' + Math.round(age/1000) + 's)');
                    renderFiles(cached.files);
                    currentParentId = parentId;
                    // üçû Actualizar breadcrumbs tambi√©n desde cach√©
                    updateBreadcrumbs(parentId);
                    return; // ‚úÖ Retorno instant√°neo desde cach√©
                } else {
                    console.log('üïê [CACHE EXPIRED] Cach√© expirado, recargando...');
                    folderCache.delete(cacheKey);
                }
            }
            
            const url = `/api/repositories/${REPOSITORIO_ID}/files${parentId ? '/' + parentId : ''}`;
            
            console.log('üîÑ [CARGANDO ARCHIVOS]', { url, parentId, fromCache: false });
            
            fetch(url)
                .then(response => {
                    console.log('üì• [RESPUESTA HTTP]', { status: response.status, ok: response.ok });
                    
                    if (!response.ok) {
                        console.error('‚ùå [ERROR HTTP]', response.status, response.statusText);
                        throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ [DATOS RECIBIDOS]', data);
                    
                    if (data.success === false) {
                        console.error('‚ùå [ERROR EN RESPUESTA]', data.error, data.message);
                        alert(`Error: ${data.message || data.error}`);
                        return;
                    }
                    
                    // Extraer archivos del objeto de respuesta
                    const files = data.files || data;
                    console.log('üìÅ [ARCHIVOS A RENDERIZAR]', { cantidad: files.length, archivos: files });
                    
                    // ‚ö° OPTIMIZACI√ìN 2: Guardar en cach√©
                    const cacheKey = `${REPOSITORIO_ID}_${parentId || 'root'}`;
                    folderCache.set(cacheKey, {
                        files: files,
                        timestamp: Date.now()
                    });
                    
                    // Limitar tama√±o de cach√© (FIFO)
                    if (folderCache.size > CACHE_MAX_SIZE) {
                        const firstKey = folderCache.keys().next().value;
                        folderCache.delete(firstKey);
                        console.log('üóëÔ∏è [CACHE] L√≠mite alcanzado, eliminando entrada m√°s antigua');
                    }
                    
                    renderFiles(files);
                    currentParentId = parentId;
                    
                    // üçû Actualizar breadcrumbs din√°micamente
                    updateBreadcrumbs(parentId);
                    
                    // ‚ö° OPTIMIZACI√ìN 3: Prefetch de carpetas visibles
                    prefetchVisibleFolders(files);
                })
                .catch(error => {
                    console.error('üí• [ERROR CR√çTICO AL CARGAR ARCHIVOS]', error);
                    console.error('   Stack:', error.stack);
                    alert('Error al cargar el contenido. Revisa la consola para m√°s detalles.');
                });
        }
        
        // Renderizar lista de archivos
        function renderFiles(files) {
            console.log('üé® [RENDERIZANDO ARCHIVOS]', { cantidad: files.length });
            
            const tbody = document.getElementById('filesList');
            const emptyState = document.getElementById('emptyState');
            
            // üî• FILTRAR la carpeta ra√≠z "/" - no debe mostrarse al usuario
            const filteredFiles = (files || []).filter(file => file.nombre !== '/');
            
            // üî• GUARDAR datos en variable global para uso en descarga m√∫ltiple
            filesData = filteredFiles;
            
            console.log('üìã [FILTRADO] Archivos originales:', files.length, '| Despu√©s de filtrar "/":', filteredFiles.length);
            
            if (!filteredFiles || filteredFiles.length === 0) {
                console.warn('‚ö†Ô∏è [SIN ARCHIVOS] Mostrando estado vac√≠o');
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('filesTable').style.display = 'none';
                return;
            }
            
            console.log('‚úÖ [RENDERIZANDO] Mostrando tabla con', filteredFiles.length, 'elementos');
            emptyState.style.display = 'none';
            document.getElementById('filesTable').style.display = 'table';
            
            tbody.innerHTML = filteredFiles.map((file, index) => {
                console.log('   üìÑ', file.nombre, '-', file.tipo, '-', file.tamanio || file.size, 'bytes');
                
                // Usar campos con alias compatibles
                const size = file.tamanio || file.size || 0;
                const updated = file.actualizadoEn || file.updatedAt || file.creadoEn || file.createdAt;
                const escapedName = (file.nombre || '').replace(/'/g, "\\'");
                
                // üÜï GITHUB-STYLE: Construir URL basada en fullPath
                let fullPath = file.fullPath || file.nombre; // fallback a nombre si no hay fullPath
                fullPath = fullPath.replace(/^\/+/, ''); // Limpiar barras iniciales
                
                // Construir URL seg√∫n contexto (proyecto o standalone)
                const fileUrl = PROYECTO_ID 
                    ? `/devportal/${ROL}/${USERNAME}/projects/P-${PROYECTO_ID}/repositories/R-${REPOSITORIO_ID}/tree/${RAMA_ACTUAL}/${fullPath}`
                    : `/devportal/${ROL}/${USERNAME}/repositories/R-${REPOSITORIO_ID}/tree/${RAMA_ACTUAL}/${fullPath}`;
                
                return `
                <tr data-nodo-id="${file.nodoId}" 
                    data-id="${file.nodoId}" 
                    data-type="${file.tipo}" 
                    data-index="${index}"
                    onclick="handleRowClick(event, ${file.nodoId}, ${index})"
                    style="cursor: pointer;">
                    <td class="checkbox-cell" style="display: none;" onclick="event.stopPropagation();">
                        <input type="checkbox" class="file-checkbox" onchange="toggleSelection(${file.nodoId})" />
                    </td>
                    <td>
                        <div class="file-name-cell">
                            <i class="file-icon ${file.tipo === 'CARPETA' ? 'folder fas fa-folder' : 'file fas fa-file'}"></i>
                            <a href="${fileUrl}" 
                               class="file-name-link" 
                               data-nodo-id="${file.nodoId}"
                               data-tipo="${file.tipo}"
                               data-fullpath="${fullPath}"
                               data-nombre="${file.nombre}"
                               onclick="return handleFileClick(event, this);"
                               title="${fullPath}">
                                ${file.nombre}
                            </a>
                        </div>
                    </td>
                    <td class="file-size">${formatSize(size)}</td>
                    <td class="file-date">${formatDate(updated)}</td>
                    <td class="file-actions" onclick="event.stopPropagation();">
                        <button class="action-btn btn-rename" 
                            onclick="event.stopPropagation(); openRenameModal(${file.nodoId}, '${escapedName}');" 
                            title="Renombrar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-download" 
                            onclick="event.stopPropagation(); downloadFile(${file.nodoId});" 
                            title="Descargar">
                            <i class="fas fa-download"></i>
                        </button>
                        ${CAN_EDIT ? `
                        <button class="action-btn btn-delete" 
                            onclick="event.stopPropagation(); if(confirm('¬øEst√°s seguro de eliminar este elemento?')) deleteFile(${file.nodoId});" 
                            title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
            }).join('');
            
            // Liberar lock de navegaci√≥n
            isNavigating = false;
            
            console.log('‚úÖ [RENDERIZADO COMPLETADO]');
        }
        
        // Nota: La navegaci√≥n ahora se hace mediante enlaces <a> con URLs reales
        // No se necesita onDoubleClick porque los enlaces manejan la navegaci√≥n
        
        // Crear carpeta
        function createFolder() {
            console.log('üèÅ [CREATE-FOLDER] Iniciando creaci√≥n de carpeta...');
            
            const nombre = document.getElementById('folderName').value.trim();
            console.log('üìù [CREATE-FOLDER] Nombre ingresado:', nombre);
            console.log('üìÇ [CREATE-FOLDER] Parent ID actual:', currentParentId);
            console.log('üè∑Ô∏è [CREATE-FOLDER] Repositorio ID:', REPOSITORIO_ID);
            
            if (!nombre) {
                console.error('‚ùå [CREATE-FOLDER] Nombre vac√≠o');
                alert('Por favor ingresa un nombre para la carpeta');
                return;
            }
            
            const payload = {
                nombre: nombre,
                parentId: currentParentId
            };
            console.log('üì¶ [CREATE-FOLDER] Payload a enviar:', JSON.stringify(payload));
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/folders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('üì° [CREATE-FOLDER] Respuesta HTTP:', response.status, response.statusText);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ [CREATE-FOLDER] Datos recibidos:', data);
                
                const modalElement = document.getElementById('createFolderModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                
                if (modalInstance) {
                    console.log('üö™ [CREATE-FOLDER] Cerrando modal...');
                    modalInstance.hide();
                } else {
                    console.warn('‚ö†Ô∏è [CREATE-FOLDER] No se encontr√≥ instancia del modal');
                }
                
                document.getElementById('folderName').value = '';
                console.log('üîÑ [CREATE-FOLDER] Recargando archivos...');
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('üí• [CREATE-FOLDER] Error:', error);
                alert('Error al crear la carpeta: ' + error.message);
            });
        }
        
        // Crear nuevo archivo vac√≠o
        function createFile() {
            console.log('üèÅ [CREATE-FILE] Iniciando creaci√≥n de archivo...');
            
            const nombre = document.getElementById('fileName').value.trim();
            console.log('üìù [CREATE-FILE] Nombre ingresado:', nombre);
            console.log('üìÇ [CREATE-FILE] Parent ID actual:', currentParentId);
            console.log('üè∑Ô∏è [CREATE-FILE] Repositorio ID:', REPOSITORIO_ID);
            
            if (!nombre) {
                console.error('‚ùå [CREATE-FILE] Nombre vac√≠o');
                alert('Por favor ingresa un nombre para el archivo');
                return;
            }
            
            // Crear un blob vac√≠o
            const blob = new Blob([''], { type: 'text/plain' });
            const file = new File([blob], nombre, { type: 'text/plain' });
            
            const formData = new FormData();
            formData.append('files', file);
            if (currentParentId) {
                formData.append('parentId', currentParentId);
            }
            
            console.log('üì¶ [CREATE-FILE] FormData preparado con archivo:', nombre);
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/files`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('üì° [CREATE-FILE] Respuesta HTTP:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error('Error al crear el archivo');
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ [CREATE-FILE] Archivo creado:', data);
                
                const modalElement = document.getElementById('createFileModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                
                if (modalInstance) {
                    console.log('üö™ [CREATE-FILE] Cerrando modal...');
                    modalInstance.hide();
                } else {
                    console.warn('‚ö†Ô∏è [CREATE-FILE] No se encontr√≥ instancia del modal');
                }
                
                document.getElementById('fileName').value = '';
                console.log('üîÑ [CREATE-FILE] Recargando archivos...');
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('üí• [CREATE-FILE] Error:', error);
                alert('Error al crear el archivo: ' + error.message);
            });
        }
        
        // Subir archivos
        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) return;
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            if (currentParentId) {
                formData.append('parentId', currentParentId);
            }
            
            document.getElementById('uploadProgress').style.display = 'block';
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('uploadFileModal')).hide();
                fileInput.value = '';
                document.getElementById('uploadProgress').style.display = 'none';
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al subir los archivos');
            });
        }
        
        // Subir carpeta
        function uploadFolder() {
            const folderInput = document.getElementById('folderInput');
            const files = folderInput.files;
            
            if (files.length === 0) return;
            
            console.log('üìÅ [UPLOAD FOLDER] Subiendo', files.length, 'archivos');
            
            // Preparar estructura de archivos con sus rutas
            const filesList = [];
            for (let file of files) {
                filesList.push({
                    file: file,
                    path: file.webkitRelativePath || file.relativePath || file.name
                });
            }
            
            // üî• Obtener elementos de progreso
            const progressDiv = document.getElementById('uploadFolderProgress');
            const statusText = document.getElementById('uploadFolderStatus');
            
            progressDiv.style.display = 'block';
            
            // üî• Subir archivos UNO POR UNO con progreso real
            let uploadedCount = 0;
            const totalFiles = filesList.length;
            
            statusText.textContent = `0 de ${totalFiles} archivos`;
            console.log('üìä [PROGRESO] Iniciando subida archivo por archivo');
            
            // Funci√≥n para subir un archivo
            async function uploadSingleFile(fileData) {
                const formData = new FormData();
                formData.append('files', fileData.file);
                formData.append('paths', fileData.path);
                
                if (currentParentId) {
                    formData.append('parentId', currentParentId);
                }
                
                try {
                    const response = await fetch(`/api/repositories/${REPOSITORIO_ID}/folders/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.filesUploaded !== undefined) {
                        uploadedCount += data.filesUploaded || 1;
                        
                        // üî• ACTUALIZAR progreso en tiempo real
                        statusText.textContent = `${uploadedCount} de ${totalFiles} archivos`;
                        console.log(`‚úÖ [${uploadedCount}/${totalFiles}] Archivo subido:`, fileData.path);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error(`‚ùå Error subiendo ${fileData.path}:`, error);
                    return false;
                }
            }
            
            // Subir todos los archivos secuencialmente
            async function uploadAllFiles() {
                for (let i = 0; i < filesList.length; i++) {
                    await uploadSingleFile(filesList[i]);
                }
                
                // üî• Finalizado
                console.log('‚úÖ [PROGRESO] Completado:', uploadedCount, 'de', totalFiles, 'archivos subidos');
                statusText.textContent = `‚úÖ ${uploadedCount} archivos subidos`;
                
                // Resetear y cerrar
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('uploadFolderModal')).hide();
                    folderInput.value = '';
                    progressDiv.style.display = 'none';
                    statusText.textContent = '';
                    // üîÑ Recargar p√°gina para obtener nodos actualizados del servidor
                    window.location.reload();
                }, 1000);
            }
            
            uploadAllFiles().catch(error => {
                console.error('‚ùå [UPLOAD FOLDER] Error general:', error);
                alert('Error al subir la carpeta');
                progressDiv.style.display = 'none';
            });
        }
        
        // ‚≠ê NUEVA FUNCI√ìN: Manejar clic en archivos/carpetas
        function handleFileClick(event, linkElement) {
            const tipo = linkElement.dataset.tipo;
            const nodoId = parseInt(linkElement.dataset.nodoId);
            const fullPath = linkElement.dataset.fullpath;
            const nombre = linkElement.dataset.nombre;
            
            console.log('üëÜ [CLICK]', { tipo, nodoId, fullPath, nombre });
            
            // Solo interceptar CARPETAS - Archivos siguen comportamiento normal
            if (tipo === 'CARPETA') {
                event.preventDefault(); // üõë Prevenir recarga de p√°gina
                event.stopPropagation();
                navigateToFolder(nodoId, fullPath, nombre);
                return false;
            }
            
            // Archivos: dejar que naveguen normalmente (para ver contenido)
            event.stopPropagation();
            return true; // Permitir navegaci√≥n normal
        }
        
        // ‚≠ê NUEVA FUNCI√ìN: Mostrar skeleton durante carga AJAX
        function showLoadingSkeleton() {
            const tbody = document.getElementById('filesList');
            const emptyState = document.getElementById('emptyState');
            
            // Ocultar estado vac√≠o
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Mostrar tabla con skeleton
            const filesTable = document.getElementById('filesTable');
            if (filesTable) {
                filesTable.style.display = 'table';
            }
            
            // Crear filas skeleton (3 filas animadas)
            tbody.innerHTML = `
                ${[1,2,3].map(() => `
                    <tr class="skeleton-row" style="animation: skeleton-pulse 1.5s ease-in-out infinite;">
                        <td><div style="height: 20px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); border-radius: 4px; background-size: 200% 100%; animation: skeleton-shimmer 1.5s ease-in-out infinite;"></div></td>
                        <td><div style="height: 16px; width: 60%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); border-radius: 4px; background-size: 200% 100%; animation: skeleton-shimmer 1.5s ease-in-out infinite;"></div></td>
                        <td><div style="height: 16px; width: 80%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); border-radius: 4px; background-size: 200% 100%; animation: skeleton-shimmer 1.5s ease-in-out infinite;"></div></td>
                        <td></td>
                    </tr>
                `).join('')}
                <style>
                    @keyframes skeleton-shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                </style>
            `;
            
            console.log('‚è≥ [SKELETON] Mostrando loading...');
        }
        
        // ‚ö° OPTIMIZACI√ìN: Prefetch de carpetas visibles en background
        function prefetchVisibleFolders(files) {
            const folders = files.filter(f => f.tipo === 'CARPETA');
            
            // Solo prefetch de las primeras 3 carpetas (balance entre velocidad y ancho de banda)
            folders.slice(0, 3).forEach((folder, index) => {
                setTimeout(() => {
                    const cacheKey = `${REPOSITORIO_ID}_${folder.nodoId}`;
                    
                    // Solo prefetch si no est√° en cach√©
                    if (!folderCache.has(cacheKey)) {
                        console.log(`üîÆ [PREFETCH] Pre-cargando carpeta: ${folder.nombre}`);
                        
                        fetch(`/api/repositories/${REPOSITORIO_ID}/files/${folder.nodoId}`)
                            .then(r => r.json())
                            .then(data => {
                                const files = data.files || data;
                                folderCache.set(cacheKey, {
                                    files: files,
                                    timestamp: Date.now()
                                });
                                console.log(`‚úÖ [PREFETCH] ${folder.nombre} cacheado (${files.length} items)`);
                            })
                            .catch(err => {
                                console.warn('‚ö†Ô∏è [PREFETCH] Error:', err);
                            });
                    }
                }, index * 200); // Escalonar requests (200ms entre cada una)
            });
        }
        
        // Formatear tama√±o
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '-';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        // Actualizar breadcrumbs din√°micamente (con cache y debouncing)
        function updateBreadcrumbs(nodoId) {
            // ‚ö° DEBOUNCING: Evitar m√∫ltiples actualizaciones simult√°neas
            if (isBreadcrumbUpdating) {
                console.log('‚è∏Ô∏è [BREADCRUMBS] Ya actualizando, ignorando llamada');
                return;
            }
            
            console.log('üçû [BREADCRUMBS] Actualizando para nodoId:', nodoId);
            
            if (!nodoId) {
                console.log('üçû [BREADCRUMBS] NodoId es null - mostrando solo ra√≠z');
                const breadcrumbNav = document.getElementById('breadcrumbNav');
                const dinamicBreadcrumbs = breadcrumbNav.querySelectorAll('.breadcrumb-dynamic');
                dinamicBreadcrumbs.forEach(el => el.remove());
                return;
            }
            
            // ‚ö° CACHE: Verificar si ya tenemos el breadcrumb
            const cached = breadcrumbCache.get(nodoId);
            if (cached) {
                const age = Date.now() - cached.timestamp;
                if (age < CACHE_TTL) {
                    console.log('‚ö° [BREADCRUMBS CACHE HIT] Edad:', Math.round(age/1000), 's');
                    renderBreadcrumbs(cached.path);
                    return;
                }
                console.log('üóëÔ∏è [BREADCRUMBS CACHE EXPIRED] Edad:', Math.round(age/1000), 's');
                breadcrumbCache.delete(nodoId);
            }
            
            isBreadcrumbUpdating = true;
            
            // Obtener ruta del backend
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}/path`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('üçû [BREADCRUMBS] Datos recibidos:', data);
                    
                    if (!data.success || !data.path) {
                        console.error('üçû [BREADCRUMBS] Error en respuesta:', data);
                        return;
                    }
                    
                    // ‚ö° GUARDAR EN CACHE
                    breadcrumbCache.set(nodoId, {
                        path: data.path,
                        timestamp: Date.now()
                    });
                    
                    // Limitar tama√±o de cache (FIFO)
                    if (breadcrumbCache.size > CACHE_MAX_SIZE) {
                        const firstKey = breadcrumbCache.keys().next().value;
                        breadcrumbCache.delete(firstKey);
                        console.log('üóëÔ∏è [BREADCRUMBS CACHE] Evicted:', firstKey);
                    }
                    
                    renderBreadcrumbs(data.path);
                })
                .catch(error => {
                    console.error('üí• [BREADCRUMBS] Error obteniendo ruta:', error);
                })
                .finally(() => {
                    isBreadcrumbUpdating = false;
                });
        }
        
        // Renderizar breadcrumbs (funci√≥n separada para reutilizar)
        function renderBreadcrumbs(pathArray) {
            const breadcrumbNav = document.getElementById('breadcrumbNav');
            
            // Eliminar breadcrumbs din√°micos anteriores
            const dinamicBreadcrumbs = breadcrumbNav.querySelectorAll('.breadcrumb-dynamic');
            dinamicBreadcrumbs.forEach(el => el.remove());
            
            // Agregar nuevos breadcrumbs desde la ruta
            pathArray.forEach((node, index) => {
                // Agregar separador
                const separator = document.createElement('span');
                separator.className = 'breadcrumb-separator breadcrumb-dynamic';
                separator.textContent = '/';
                breadcrumbNav.appendChild(separator);
                
                // Agregar breadcrumb item
                const breadcrumbItem = document.createElement('div');
                breadcrumbItem.className = 'breadcrumb-item breadcrumb-dynamic';
                
                const isLast = index === pathArray.length - 1;
                
                if (isLast) {
                    // √öltimo elemento: solo texto, sin link
                    const span = document.createElement('span');
                    span.style.color = 'var(--text-primary)';
                    span.style.fontWeight = '500';
                    span.textContent = node.nombre;
                    breadcrumbItem.appendChild(span);
                } else {
                    // Elementos intermedios: clickeables
                    const link = document.createElement('a');
                    link.href = 'javascript:void(0)';
                    link.textContent = node.nombre;
                    link.onclick = () => {
                        console.log(`üçû [BREADCRUMBS] Click en "${node.nombre}" (ID: ${node.nodoId})`);
                        loadFiles(node.nodoId);
                        updateBreadcrumbs(node.nodoId);
                    };
                    breadcrumbItem.appendChild(link);
                }
                
                breadcrumbNav.appendChild(breadcrumbItem);
            });
            
            console.log('‚úÖ [BREADCRUMBS] Renderizado completado');
        }
        
        // Seleccionar/deseleccionar items
        function toggleSelection(nodoId) {
            const index = selectedItems.indexOf(nodoId);
            if (index > -1) {
                selectedItems.splice(index, 1);
            } else {
                selectedItems.push(nodoId);
            }
            updateToolbar();
        }
        
        function updateToolbar() {
            document.getElementById('btnDownload').style.display = selectedItems.length > 0 ? 'inline-flex' : 'none';
            document.getElementById('btnDelete').style.display = selectedItems.length > 0 ? 'inline-flex' : 'none';
        }
        
        // Funciones de acciones (implementar)
        function openRenameModal(nodoId, currentName) {
            document.getElementById('renameNodoId').value = nodoId;
            document.getElementById('newName').value = currentName || '';
            new bootstrap.Modal(document.getElementById('renameModal')).show();
        }
        
        function renameItem() {
            const nodoId = document.getElementById('renameNodoId').value;
            const newName = document.getElementById('newName').value.trim();
            
            if (!newName) return;
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: newName })
            })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al renombrar');
            });
        }
        
        function downloadFile(nodoId) {
            console.log('üì• [DOWNLOAD] Iniciando descarga de archivo ID:', nodoId);
            
            // Usar fetch para descargar sin abrir pesta√±a nueva
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}/download`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la descarga');
                    }
                    
                    // Obtener nombre del archivo desde Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'archivo';
                    if (contentDisposition) {
                        const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                            // Decodificar si est√° en formato UTF-8
                            try {
                                filename = decodeURIComponent(filename);
                            } catch (e) {
                                // Si falla, usar el nombre sin decodificar
                            }
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    // Crear URL temporal y descargar
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Limpiar
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    console.log('‚úÖ [DOWNLOAD] Archivo descargado:', filename);
                })
                .catch(error => {
                    console.error('‚ùå [DOWNLOAD] Error:', error);
                    showNotification('error', 'Error al descargar el archivo');
                });
        }
        
        // ==================== SELECCI√ìN ESTILO WINDOWS EXPLORER ====================
        
        let lastSelectedIndex = -1;
        
        // Manejar click en fila con soporte para Ctrl+Click
        function handleRowClick(event, nodoId, rowIndex) {
            // No procesar si es click en bot√≥n de acci√≥n o en enlace
            if (event.target.closest('.action-btn')) return;
            if (event.target.closest('.file-name-link')) return;
            
            const allRows = Array.from(document.querySelectorAll('tr[data-nodo-id]'));
            const clickedIndex = rowIndex;
            
            if (event.ctrlKey || event.metaKey) {
                // Ctrl+Click (o Cmd+Click en Mac): Agregar/quitar de selecci√≥n m√∫ltiple
                const index = selectedItems.indexOf(nodoId);
                if (index > -1) {
                    selectedItems.splice(index, 1);
                } else {
                    selectedItems.push(nodoId);
                }
                lastSelectedIndex = clickedIndex;
            } else if (event.shiftKey && lastSelectedIndex !== -1) {
                // Shift+Click: Seleccionar rango
                const start = Math.min(lastSelectedIndex, clickedIndex);
                const end = Math.max(lastSelectedIndex, clickedIndex);
                selectedItems = [];
                for (let i = start; i <= end; i++) {
                    const rowNodoId = parseInt(allRows[i].dataset.nodoId);
                    if (!selectedItems.includes(rowNodoId)) {
                        selectedItems.push(rowNodoId);
                    }
                }
            } else {
                // Click simple: Seleccionar solo este item
                selectedItems = [nodoId];
                lastSelectedIndex = clickedIndex;
            }
            
            updateSelectionUI();
        }
        
        // Actualizar UI de selecci√≥n
        function updateSelectionUI() {
            // Actualizar todas las filas
            document.querySelectorAll('tr[data-nodo-id]').forEach(row => {
                const nodoId = parseInt(row.dataset.nodoId);
                const isSelected = selectedItems.includes(nodoId);
                
                // Actualizar clase CSS
                row.classList.toggle('selected', isSelected);
                
                // Actualizar checkbox si existe
                const checkbox = row.querySelector('.file-checkbox');
                if (checkbox) {
                    checkbox.checked = isSelected;
                }
            });
            
            updateToolbar();
        }
        
        // ==================== CLICK DERECHO - MEN√ö CONTEXTUAL ====================
        
        // Mostrar men√∫ contextual
        function showContextMenu(x, y, onSelection = false) {
            const contextMenu = document.getElementById('contextMenu');
            
            // Habilitar/deshabilitar opciones seg√∫n contexto
            const hasSelection = selectedItems.length > 0;
            const singleSelection = selectedItems.length === 1;
            
            console.log('üìã [CONTEXT MENU] onSelection:', onSelection, 'hasSelection:', hasSelection);
            
            // Show/hide items based on context (selection vs empty space)
            document.querySelectorAll('.context-on-selection').forEach(item => {
                item.style.display = onSelection ? 'flex' : 'none';
            });
            document.querySelectorAll('.context-on-empty').forEach(item => {
                item.style.display = !onSelection ? 'flex' : 'none';
            });
            
            document.querySelectorAll('.context-menu-item').forEach(item => {
                const action = item.onclick?.toString() || '';
                
                // Renombrar: solo con 1 elemento
                if (action.includes('contextMenuRename')) {
                    item.classList.toggle('disabled', !singleSelection);
                }
                
                // Copiar/Cortar/Eliminar/Descargar: requieren selecci√≥n
                if (action.includes('copy') || action.includes('cut') || action.includes('delete') || action.includes('Download')) {
                    item.classList.toggle('disabled', !hasSelection);
                }
                
                // Pegar: requiere clipboard
                if (action.includes('paste')) {
                    item.classList.toggle('disabled', !clipboardState);
                }
            });
            
            // Posicionar men√∫
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.add('show');
            
            // Ajustar si se sale de la pantalla
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (x - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (y - rect.height) + 'px';
            }
        }
        
        // Ocultar men√∫ contextual
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }
        
        // Helper functions para modales
        function openCreateFileModal() {
            hideContextMenu();
            const modal = new bootstrap.Modal(document.getElementById('createFileModal'));
            modal.show();
            setTimeout(() => {
                document.getElementById('fileName').focus();
            }, 300);
        }
        
        function openCreateFolderModal() {
            hideContextMenu();
            const modal = new bootstrap.Modal(document.getElementById('createFolderModal'));
            modal.show();
            setTimeout(() => {
                document.getElementById('folderName').focus();
            }, 300);
        }
        
        function openUploadFileModal() {
            hideContextMenu();
            const modal = new bootstrap.Modal(document.getElementById('uploadFileModal'));
            modal.show();
        }
        
        function openUploadFolderModal() {
            hideContextMenu();
            const modal = new bootstrap.Modal(document.getElementById('uploadFolderModal'));
            modal.show();
        }
        
        // Event listener para click derecho en filas
        document.addEventListener('contextmenu', function(e) {
            const fileRow = e.target.closest('tr[data-nodo-id]');
            const filesTable = e.target.closest('#filesTable');
            const filesContent = e.target.closest('.files-content');
            const emptyState = e.target.closest('.empty-state');
            
            console.log('üñ±Ô∏è [RIGHT CLICK]', {
                fileRow: !!fileRow,
                filesContent: !!filesContent,
                filesTable: !!filesTable,
                emptyState: !!emptyState,
                target: e.target.className
            });
            
            if (fileRow) {
                e.preventDefault();
                const nodoId = parseInt(fileRow.dataset.nodoId);
                
                // Si el item clickeado NO est√° seleccionado, seleccionarlo solo a √©l
                if (!selectedItems.includes(nodoId)) {
                    selectedItems = [nodoId];
                    updateSelectionUI();
                }
                
                showContextMenu(e.pageX, e.pageY, true);
            } else if (filesContent || filesTable || emptyState) {
                // Click derecho en √°rea vac√≠a (fuera de las filas)
                e.preventDefault();
                
                // Deseleccionar todo
                selectedItems = [];
                updateSelectionUI();
                
                showContextMenu(e.pageX, e.pageY, false);
            }
        });
        
        // Cerrar men√∫ al hacer click fuera
        document.addEventListener('click', function(e) {
            const contextMenu = document.getElementById('contextMenu');
            const isFileRow = e.target.closest('tr[data-nodo-id]');
            const isActionButton = e.target.closest('.action-btn');
            const isToolbarButton = e.target.closest('.btn-group button');
            const isContextMenu = e.target.closest('#contextMenu');
            
            // Ocultar men√∫ contextual
            if (!isContextMenu) {
                hideContextMenu();
            }
            
            // Deseleccionar si se hace click fuera
            if (!isFileRow && !isActionButton && !isToolbarButton && !isContextMenu) {
                selectedItems = [];
                lastSelectedIndex = -1;
                updateSelectionUI();
            }
        });
        
        // Funciones del men√∫ contextual
        function contextMenuRename() {
            if (selectedItems.length !== 1) return;
            hideContextMenu();
            const nodoId = selectedItems[0];
            const row = document.querySelector(`tr[data-nodo-id="${nodoId}"]`);
            const nombre = row?.querySelector('.file-name')?.textContent || '';
            openRenameModal(nodoId, nombre);
        }
        
        function contextMenuDownload() {
            if (selectedItems.length === 0) return;
            hideContextMenu();
            
            if (selectedItems.length === 1) {
                downloadFile(selectedItems[0]);
            } else {
                showNotification('info', `Descargando ${selectedItems.length} archivos...`);
                selectedItems.forEach(nodoId => downloadFile(nodoId));
            }
        }
        
        function contextMenuProperties() {
            if (selectedItems.length !== 1) return;
            hideContextMenu();
            showNotification('info', 'Panel de propiedades en desarrollo');
            // TODO: Implementar modal de propiedades
        }
        
        // ==================== ATAJOS DE TECLADO MEJORADOS ====================
        
        document.addEventListener('keydown', function(e) {
            // No ejecutar si el usuario est√° escribiendo en un input o textarea
            const isTyping = e.target.matches('input, textarea, [contenteditable="true"]');
            const isModalOpen = document.querySelector('.modal.show') !== null;
            
            // No ejecutar atajos si hay un modal abierto (excepto Enter y Escape)
            if (isModalOpen && !['Enter', 'Escape'].includes(e.key)) {
                return;
            }
            
            // Escape - Cerrar men√∫ contextual o deseleccionar
            if (e.key === 'Escape') {
                hideContextMenu();
                if (selectedItems.length > 0) {
                    selectedItems = [];
                    lastSelectedIndex = -1;
                    updateSelectionUI();
                }
                return;
            }
            
            // No ejecutar m√°s atajos si est√° escribiendo
            if (isTyping) return;
            
            // Ctrl+C - Copiar
            if (e.ctrlKey && e.key === 'c' && selectedItems.length > 0) {
                e.preventDefault();
                copyToClipboard();
            }
            
            // Ctrl+X - Cortar
            else if (e.ctrlKey && e.key === 'x' && selectedItems.length > 0) {
                e.preventDefault();
                cutToClipboard();
            }
            
            // Ctrl+V - Pegar
            else if (e.ctrlKey && e.key === 'v' && clipboardState) {
                e.preventDefault();
                pasteFromClipboard();
            }
            
            // Ctrl+A - Seleccionar todo
            else if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                selectAll();
            }
            
            // Alt+N - Nuevo archivo
            else if (e.altKey && e.key === 'n') {
                e.preventDefault();
                openCreateFileModal();
            }
            
            // Alt+Shift+N - Nueva carpeta
            else if (e.altKey && e.shiftKey && e.key === 'N') {
                e.preventDefault();
                openCreateFolderModal();
            }
            
            // Alt+U - Subir archivo
            else if (e.altKey && e.key === 'u') {
                e.preventDefault();
                openUploadFileModal();
            }
            
            // Alt+Shift+U - Subir carpeta
            else if (e.altKey && e.shiftKey && e.key === 'U') {
                e.preventDefault();
                openUploadFolderModal();
            }
            
            // Delete/Supr - Eliminar seleccionados
            else if ((e.key === 'Delete' || e.key === 'Supr') && selectedItems.length > 0) {
                e.preventDefault();
                deleteSelected();
            }
            
            // F2 - Renombrar (solo si hay 1 archivo seleccionado)
            else if (e.key === 'F2' && selectedItems.length === 1) {
                e.preventDefault();
                contextMenuRename();
            }
            
            // Enter - Abrir carpeta o archivo seleccionado
            else if (e.key === 'Enter' && selectedItems.length === 1) {
                e.preventDefault();
                const nodoId = selectedItems[0];
                const row = document.querySelector(`tr[data-nodo-id="${nodoId}"]`);
                const tipo = row?.dataset.type;
                onDoubleClick(nodoId, tipo);
            }
            
            // Ctrl+D - Descargar seleccionados
            else if (e.ctrlKey && e.key === 'd' && selectedItems.length > 0) {
                e.preventDefault();
                contextMenuDownload();
            }
            
            // Flechas de navegaci√≥n (TODO: implementar navegaci√≥n con teclado)
            else if (['ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
                navigateWithArrows(e.key);
            }
        });
        
        // Navegaci√≥n con flechas de teclado
        function navigateWithArrows(key) {
            const allRows = Array.from(document.querySelectorAll('tr[data-nodo-id]'));
            if (allRows.length === 0) return;
            
            let currentIndex = selectedItems.length === 1 
                ? allRows.findIndex(row => parseInt(row.dataset.nodoId) === selectedItems[0])
                : -1;
            
            if (key === 'ArrowDown') {
                currentIndex = Math.min(currentIndex + 1, allRows.length - 1);
            } else if (key === 'ArrowUp') {
                currentIndex = Math.max(currentIndex - 1, 0);
            }
            
            if (currentIndex >= 0) {
                const newNodoId = parseInt(allRows[currentIndex].dataset.nodoId);
                selectedItems = [newNodoId];
                lastSelectedIndex = currentIndex;
                updateSelectionUI();
                
                // Scroll para mantener visible
                allRows[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // ==================== CLIPBOARD OPERATIONS ====================
        
        let clipboardState = null;
        
        // Verificar si hay algo en el portapapeles
        async function checkClipboardStatus() {
            try {
                const response = await fetch(`/api/repositories/${REPOSITORIO_ID}/clipboard/status`);
                const data = await response.json();
                
                clipboardState = data.hasClipboard ? data : null;
                
                const btnPaste = document.getElementById('btnPaste');
                const pasteText = document.getElementById('pasteText');
                
                if (data.hasClipboard) {
                    btnPaste.style.display = 'inline-flex';
                    const operationType = data.operation === 'COPY' ? 'copiados' : 'cortados';
                    pasteText.textContent = `Pegar (${data.count} ${operationType})`;
                } else {
                    btnPaste.style.display = 'none';
                }
            } catch (error) {
                console.log('No hay clipboard activo');
            }
        }
        
        // Copiar archivos seleccionados
        async function copyToClipboard() {
            if (selectedItems.length === 0) return;
            
            try {
                const response = await fetch(`/api/repositories/${REPOSITORIO_ID}/clipboard/copy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nodoIds: selectedItems })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('success', data.message);
                    checkClipboardStatus();
                    // No deseleccionar para permitir m√°s operaciones
                } else {
                    showNotification('error', data.error || 'Error al copiar');
                }
            } catch (error) {
                console.error('Error al copiar:', error);
                showNotification('error', 'Error al copiar archivos');
            }
        }
        
        // Cortar archivos seleccionados
        async function cutToClipboard() {
            if (selectedItems.length === 0) return;
            
            try {
                const response = await fetch(`/api/repositories/${REPOSITORIO_ID}/clipboard/cut`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nodoIds: selectedItems })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('warning', data.message);
                    checkClipboardStatus();
                    
                    // Marcar visualmente archivos cortados
                    selectedItems.forEach(nodoId => {
                        const row = document.querySelector(`tr[data-nodo-id="${nodoId}"]`);
                        if (row) row.classList.add('cut-item');
                    });
                } else {
                    showNotification('error', data.error || 'Error al cortar');
                }
            } catch (error) {
                console.error('Error al cortar:', error);
                showNotification('error', 'Error al cortar archivos');
            }
        }
        
        // Pegar archivos del clipboard
        async function pasteFromClipboard() {
            if (!clipboardState) {
                showNotification('warning', 'No hay archivos en el portapapeles');
                return;
            }
            
            try {
                const response = await fetch(`/api/repositories/${REPOSITORIO_ID}/clipboard/paste`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ parentId: currentParentId })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const operation = clipboardState.operation === 'COPY' ? 'copiado(s)' : 'movido(s)';
                    showNotification('success', `${data.count || clipboardState.count} archivo(s) ${operation} exitosamente`);
                    checkClipboardStatus();
                    loadFiles(currentParentId); // Recargar lista
                    
                    // Limpiar selecci√≥n y marcas visuales
                    selectedItems = [];
                    document.querySelectorAll('.cut-item').forEach(row => {
                        row.classList.remove('cut-item');
                    });
                    updateToolbar();
                } else {
                    showNotification('error', data.error || data.message || 'Error al pegar');
                }
            } catch (error) {
                console.error('Error al pegar:', error);
                showNotification('error', `Error al pegar: ${error.message}`);
            }
        }
        
        // ==================== FIN CLIPBOARD OPERATIONS ====================
        
        // Mostrar notificaci√≥n toast
        function showNotification(type, message) {
            // Crear toast si no existe
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger'} fade show`;
            toast.style.cssText = 'min-width: 300px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'times-circle'}"></i>
                ${message}
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Seleccionar todos los archivos
        function selectAll() {
            const rows = document.querySelectorAll('tr[data-nodo-id]');
            selectedItems = Array.from(rows).map(row => parseInt(row.dataset.nodoId));
            updateSelectionUI();
            showNotification('info', `${selectedItems.length} archivo(s) seleccionado(s)`);
        }
        
        // Eliminar archivos seleccionados
        async function deleteSelected() {
            if (selectedItems.length === 0) return;
            
            const confirmMsg = selectedItems.length === 1 
                ? '¬øEst√°s seguro de eliminar este archivo?' 
                : `¬øEst√°s seguro de eliminar ${selectedItems.length} archivos?`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Eliminar cada archivo sin recargar
                for (const nodoId of selectedItems) {
                    await deleteFile(nodoId, false);
                }
                
                showNotification('success', `${selectedItems.length} archivo(s) eliminado(s)`);
                selectedItems = [];
                lastSelectedIndex = -1;
                updateSelectionUI();
                loadFiles(currentParentId); // Recargar una sola vez al final
            } catch (error) {
                console.error('Error al eliminar archivos:', error);
                showNotification('error', 'Error al eliminar archivos');
            }
        }
        
        function deleteFile(nodoId, shouldReload = true) {
            if (shouldReload && !confirm('¬øEst√°s seguro de que deseas eliminar este elemento?')) {
                return Promise.reject('Cancelado por el usuario');
            }
            
            return fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}`, {
                method: 'DELETE'
            })
            .then(() => {
                if (shouldReload) {
                    loadFiles(currentParentId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (shouldReload) {
                    alert('Error al eliminar');
                }
                throw error; // Re-lanzar para que deleteSelected pueda capturarlo
            });
        }
        /*]]>*/
    </script>
    
    <!-- Men√∫ Contextual (Click Derecho) -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="copyToClipboard()">
            <i class="fas fa-copy"></i>
            <span>Copiar</span>
            <span class="shortcut">Ctrl+C</span>
        </div>
        <div class="context-menu-item" onclick="cutToClipboard()">
            <i class="fas fa-cut"></i>
            <span>Cortar</span>
            <span class="shortcut">Ctrl+X</span>
        </div>
        <div class="context-menu-item" id="contextPaste" onclick="pasteFromClipboard()">
            <i class="fas fa-paste"></i>
            <span>Pegar</span>
            <span class="shortcut">Ctrl+V</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="contextRename" onclick="contextMenuRename()">
            <i class="fas fa-edit"></i>
            <span>Renombrar</span>
            <span class="shortcut">F2</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuDownload()">
            <i class="fas fa-download"></i>
            <span>Descargar</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="deleteSelected()">
            <i class="fas fa-trash text-danger"></i>
            <span class="text-danger">Eliminar</span>
            <span class="shortcut">Supr</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="selectAll()">
            <i class="fas fa-check-square"></i>
            <span>Seleccionar todo</span>
            <span class="shortcut">Ctrl+A</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuProperties()">
            <i class="fas fa-info-circle"></i>
            <span>Propiedades</span>
        </div>
    </div>
    
    <!-- Chatbot Widget -->
    <div th:replace="~{fragments/chatbot-widget :: chatbot-widget}"></div>

</body>
</html>


