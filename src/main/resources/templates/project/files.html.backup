<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${'Contenido - ' + repositorio.nombreRepositorio}">Contenido - Repositorio</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/project-repository.css}">
    
    <style>
        :root {
            --primary-color: #2596be;
            --primary-dark: #1e7a9a;
            --primary-light: #e3f2fd;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-light: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        .files-container {
            padding: 1.5rem;
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .files-header {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }
        
        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .breadcrumb-item a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb-item a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            color: var(--text-muted);
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary-action {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary-action:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary-action {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary-action:hover {
            background: #5a6268;
        }
        
        .btn-danger-action {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger-action:hover {
            background: #c82333;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }
        
        .search-box i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        .files-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--border-light);
        }
        
        .files-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .files-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid var(--border-light);
        }
        
        .files-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .files-table tbody tr {
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .files-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .files-table tbody tr.selected {
            background-color: var(--primary-light);
        }
        
        .files-table td {
            padding: 0.875rem 1rem;
            font-size: 0.9rem;
        }
        
        .file-name-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .file-icon {
            font-size: 1.5rem;
            width: 2rem;
            text-align: center;
        }
        
        .file-icon.folder {
            color: #FFA500;
        }
        
        .file-icon.file {
            color: #64B5F6;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .file-size {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .file-date {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .files-table tbody tr:hover .file-actions {
            opacity: 1;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }
        
        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s;
        }
        
        .context-menu-item:hover {
            background-color: #f8f9fa;
        }
        
        .context-menu-item i {
            width: 1.25rem;
        }
        
        .modal-backdrop.show {
            opacity: 0.5;
        }
        
        /* FIX: Asegurar que el modal se muestre correctamente */
        .modal {
            z-index: 1055 !important;
            display: block !important; /* Forzar display cuando tenga clase .show */
        }
        
        .modal.fade.show {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
        
        .modal-dialog {
            z-index: 1060 !important;
            margin: 1.75rem auto !important;
            transform: none !important;
        }
        
        .modal.show .modal-dialog {
            transform: translate(0, 0) !important;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="files-container">
        <!-- Header con breadcrumbs -->
        <div class="files-header">
            <!-- Breadcrumbs -->
            <nav class="breadcrumb-nav" id="breadcrumbNav">
                <div class="breadcrumb-item">
                    <a th:href="@{/devportal/{rol}/{username}/repositories(rol=${rol}, username=${username})}">
                        <i class="fas fa-code-branch"></i> Repositorios
                    </a>
                </div>
                <span class="breadcrumb-separator">/</span>
                <div class="breadcrumb-item">
                    <a th:href="@{/devportal/{rol}/{username}/repositories/R-{id}(rol=${rol}, username=${username}, id=${repositorio.repositorioId})}">
                        <span th:text="${repositorio.nombreRepositorio}">Repositorio</span>
                    </a>
                </div>
                <span class="breadcrumb-separator">/</span>
                <div class="breadcrumb-item">
                    <span style="color: var(--text-primary); font-weight: 500;">Contenido</span>
                </div>
                <!-- Breadcrumbs din√°micos se agregar√°n aqu√≠ v√≠a JavaScript -->
            </nav>
            
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Buscar archivos y carpetas..." />
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="toolbar-actions">
                    <button class="btn-action btn-primary-action" data-bs-toggle="modal" data-bs-target="#createFolderModal" th:if="${canEdit}">
                        <i class="fas fa-folder-plus"></i>
                        Nueva carpeta
                    </button>
                    <button class="btn-action btn-primary-action" data-bs-toggle="modal" data-bs-target="#uploadFileModal" th:if="${canEdit}">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Subir archivo
                    </button>
                    <button class="btn-action btn-secondary-action" id="btnDownload" style="display: none;">
                        <i class="fas fa-download"></i>
                        Descargar
                    </button>
                    <button class="btn-action btn-danger-action" id="btnDelete" style="display: none;" th:if="${canEdit}">
                        <i class="fas fa-trash"></i>
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Contenido de archivos -->
        <div class="files-content">
            <!-- Estado vac√≠o -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-folder-open"></i>
                <h5>Esta carpeta est√° vac√≠a</h5>
                <p>Arrastra archivos aqu√≠ o usa los botones de arriba para comenzar</p>
            </div>
            
            <!-- Tabla de archivos -->
            <table class="files-table" id="filesTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="selectAll" />
                        </th>
                        <th>Nombre</th>
                        <th style="width: 120px;">Tama√±o</th>
                        <th style="width: 180px;">√öltima modificaci√≥n</th>
                        <th style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="filesList">
                    <!-- Se llena din√°micamente v√≠a JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal: Crear Carpeta -->
    <div class="modal fade" id="createFolderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-plus text-primary"></i>
                        Nueva carpeta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createFolderForm">
                        <div class="mb-3">
                            <label for="folderName" class="form-label">Nombre de la carpeta</label>
                            <input type="text" class="form-control" id="folderName" required 
                                   placeholder="Ej: Documentos" maxlength="255" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createFolder()">
                        <i class="fas fa-check"></i> Crear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Subir Archivo -->
    <div class="modal fade" id="uploadFileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cloud-upload-alt text-primary"></i>
                        Subir archivo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadFileForm">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Seleccionar archivos</label>
                            <input type="file" class="form-control" id="fileInput" multiple required />
                            <small class="text-muted">Tama√±o m√°ximo: 100MB por archivo</small>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-2" id="uploadStatus"></small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="uploadFiles()">
                        <i class="fas fa-upload"></i> Subir
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Renombrar -->
    <div class="modal fade" id="renameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit text-primary"></i>
                        Renombrar
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="renameForm">
                        <input type="hidden" id="renameNodoId" />
                        <div class="mb-3">
                            <label for="newName" class="form-label">Nuevo nombre</label>
                            <input type="text" class="form-control" id="newName" required maxlength="255" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="renameItem()">
                        <i class="fas fa-check"></i> Renombrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Men√∫ Contextual -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="openRenameModal()">
            <i class="fas fa-edit"></i> Renombrar
        </div>
        <div class="context-menu-item" onclick="downloadItem()">
            <i class="fas fa-download"></i> Descargar
        </div>
        <div class="context-menu-item" onclick="deleteItem()">
            <i class="fas fa-trash"></i> Eliminar
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript del File System -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const REPOSITORIO_ID = /*[[${repositorio.repositorioId}]]*/ 0;
        const ROL = /*[[${rol}]]*/ 'po';
        const USERNAME = /*[[${username}]]*/ 'user';
        const CAN_EDIT = /*[[${canEdit}]]*/ false;
        
        let currentPath = '/';
        let currentParentId = null;
        let selectedItems = [];
        
        // Cargar contenido inicial
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [INIT] P√°gina cargada, inicializando...');
            console.log('üè∑Ô∏è [INIT] Repositorio ID:', REPOSITORIO_ID);
            console.log('üë§ [INIT] Usuario:', USERNAME, '| Rol:', ROL);
            console.log('‚úèÔ∏è [INIT] Puede editar:', CAN_EDIT);
            
            loadFiles(null);
            
            // Event listeners para modales (debugging)
            const createFolderModal = document.getElementById('createFolderModal');
            if (createFolderModal) {
                createFolderModal.addEventListener('show.bs.modal', function() {
                    console.log('üö™ [MODAL] Abriendo modal de crear carpeta...');
                });
                
                createFolderModal.addEventListener('shown.bs.modal', function() {
                    console.log('‚úÖ [MODAL] Modal de crear carpeta VISIBLE');
                    // Auto-focus en el input
                    document.getElementById('folderName').focus();
                });
                
                createFolderModal.addEventListener('hide.bs.modal', function() {
                    console.log('üö™ [MODAL] Cerrando modal de crear carpeta...');
                });
                
                createFolderModal.addEventListener('hidden.bs.modal', function() {
                    console.log('‚úÖ [MODAL] Modal de crear carpeta CERRADO');
                });
                
                // WORKAROUND: Forzar visibilidad despu√©s de 100ms si no aparece
                createFolderModal.addEventListener('show.bs.modal', function() {
                    setTimeout(() => {
                        const modalDialog = createFolderModal.querySelector('.modal-dialog');
                        const computedStyle = window.getComputedStyle(createFolderModal);
                        
                        console.log('üîç [MODAL-DEBUG] Estado actual:');
                        console.log('   - Display:', computedStyle.display);
                        console.log('   - Opacity:', computedStyle.opacity);
                        console.log('   - Visibility:', computedStyle.visibility);
                        console.log('   - Z-index:', computedStyle.zIndex);
                        console.log('   - Classes:', createFolderModal.className);
                        console.log('   - Tiene .show?:', createFolderModal.classList.contains('show'));
                        
                        if (modalDialog) {
                            const dialogStyle = window.getComputedStyle(modalDialog);
                            console.log('   - Dialog transform:', dialogStyle.transform);
                            console.log('   - Dialog display:', dialogStyle.display);
                        }
                        
                        // Si no tiene la clase 'show', hay un problema
                        if (!createFolderModal.classList.contains('show')) {
                            console.error('‚ùå [MODAL] No tiene clase .show despu√©s de 100ms - Forzando...');
                            createFolderModal.classList.add('show');
                            createFolderModal.style.display = 'block';
                            createFolderModal.style.paddingRight = '17px';
                            
                            // Agregar backdrop si no existe
                            if (!document.querySelector('.modal-backdrop')) {
                                const backdrop = document.createElement('div');
                                backdrop.className = 'modal-backdrop fade show';
                                document.body.appendChild(backdrop);
                            }
                        }
                    }, 100);
                });
            } else {
                console.error('‚ùå [MODAL] No se encontr√≥ el elemento createFolderModal');
            }
        });
        
        // Cargar archivos de una carpeta
        function loadFiles(parentId) {
            const url = `/api/repositories/${REPOSITORIO_ID}/files${parentId ? '/' + parentId : ''}`;
            
            console.log('üîÑ [CARGANDO ARCHIVOS]', { url, parentId });
            
            fetch(url)
                .then(response => {
                    console.log('üì• [RESPUESTA HTTP]', { status: response.status, ok: response.ok });
                    
                    if (!response.ok) {
                        console.error('‚ùå [ERROR HTTP]', response.status, response.statusText);
                        throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ [DATOS RECIBIDOS]', data);
                    
                    if (data.success === false) {
                        console.error('‚ùå [ERROR EN RESPUESTA]', data.error, data.message);
                        alert(`Error: ${data.message || data.error}`);
                        return;
                    }
                    
                    // Extraer archivos del objeto de respuesta
                    const files = data.files || data;
                    console.log('üìÅ [ARCHIVOS A RENDERIZAR]', { cantidad: files.length, archivos: files });
                    
                    renderFiles(files);
                    currentParentId = parentId;
                })
                .catch(error => {
                    console.error('üí• [ERROR CR√çTICO AL CARGAR ARCHIVOS]', error);
                    console.error('   Stack:', error.stack);
                    alert('Error al cargar el contenido. Revisa la consola para m√°s detalles.');
                });
        }
        
        // Renderizar lista de archivos
        function renderFiles(files) {
            console.log('üé® [RENDERIZANDO ARCHIVOS]', { cantidad: files.length });
            
            const tbody = document.getElementById('filesList');
            const emptyState = document.getElementById('emptyState');
            
            // üî• FILTRAR la carpeta ra√≠z "/" - no debe mostrarse al usuario
            const filteredFiles = (files || []).filter(file => file.nombre !== '/');
            
            console.log('üìã [FILTRADO] Archivos originales:', files.length, '| Despu√©s de filtrar "/":', filteredFiles.length);
            
            if (!filteredFiles || filteredFiles.length === 0) {
                console.warn('‚ö†Ô∏è [SIN ARCHIVOS] Mostrando estado vac√≠o');
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('filesTable').style.display = 'none';
                return;
            }
            
            console.log('‚úÖ [RENDERIZANDO] Mostrando tabla con', filteredFiles.length, 'elementos');
            emptyState.style.display = 'none';
            document.getElementById('filesTable').style.display = 'table';
            
            tbody.innerHTML = filteredFiles.map(file => {
                console.log('   üìÑ', file.nombre, '-', file.tipo, '-', file.tamanio || file.size, 'bytes');
                
                // Usar campos con alias compatibles
                const size = file.tamanio || file.size || 0;
                const updated = file.actualizadoEn || file.updatedAt || file.creadoEn || file.createdAt;
                
                return `
                <tr data-id="${file.nodoId}" data-type="${file.tipo}" ondblclick="onDoubleClick(${file.nodoId}, '${file.tipo}')">
                    <td><input type="checkbox" class="file-checkbox" onchange="toggleSelection(${file.nodoId})" /></td>
                    <td>
                        <div class="file-name-cell">
                            <i class="file-icon ${file.tipo === 'CARPETA' ? 'folder fas fa-folder' : 'file fas fa-file'}"></i>
                            <span class="file-name">${file.nombre}</span>
                        </div>
                    </td>
                    <td class="file-size">${formatSize(size)}</td>
                    <td class="file-date">${formatDate(updated)}</td>
                    <td class="file-actions">
                        <button class="action-btn" onclick="openRenameModal(${file.nodoId}, '${file.nombre}')" title="Renombrar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="downloadFile(${file.nodoId})" title="Descargar">
                            <i class="fas fa-download"></i>
                        </button>
                        ${CAN_EDIT ? `
                        <button class="action-btn" onclick="deleteFile(${file.nodoId})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
            }).join('');
            
            console.log('‚úÖ [RENDERIZADO COMPLETADO]');
        }
        
        // Doble click: navegar carpeta o abrir archivo
        function onDoubleClick(nodoId, tipo) {
            if (tipo === 'CARPETA') {
                loadFiles(nodoId);
                updateBreadcrumbs(nodoId);
            } else {
                // Abrir archivo (implementar vista previa)
                window.open(`/api/files/${nodoId}/download`, '_blank');
            }
        }
        
        // Crear carpeta
        function createFolder() {
            console.log('üèÅ [CREATE-FOLDER] Iniciando creaci√≥n de carpeta...');
            
            const nombre = document.getElementById('folderName').value.trim();
            console.log('üìù [CREATE-FOLDER] Nombre ingresado:', nombre);
            console.log('üìÇ [CREATE-FOLDER] Parent ID actual:', currentParentId);
            console.log('üè∑Ô∏è [CREATE-FOLDER] Repositorio ID:', REPOSITORIO_ID);
            
            if (!nombre) {
                console.error('‚ùå [CREATE-FOLDER] Nombre vac√≠o');
                alert('Por favor ingresa un nombre para la carpeta');
                return;
            }
            
            const payload = {
                nombre: nombre,
                parentId: currentParentId
            };
            console.log('üì¶ [CREATE-FOLDER] Payload a enviar:', JSON.stringify(payload));
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/folders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('üì° [CREATE-FOLDER] Respuesta HTTP:', response.status, response.statusText);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ [CREATE-FOLDER] Datos recibidos:', data);
                
                const modalElement = document.getElementById('createFolderModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                
                if (modalInstance) {
                    console.log('üö™ [CREATE-FOLDER] Cerrando modal...');
                    modalInstance.hide();
                } else {
                    console.warn('‚ö†Ô∏è [CREATE-FOLDER] No se encontr√≥ instancia del modal');
                }
                
                document.getElementById('folderName').value = '';
                console.log('üîÑ [CREATE-FOLDER] Recargando archivos...');
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('üí• [CREATE-FOLDER] Error:', error);
                alert('Error al crear la carpeta: ' + error.message);
            });
        }
        
        // Subir archivos
        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) return;
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            if (currentParentId) {
                formData.append('parentId', currentParentId);
            }
            
            document.getElementById('uploadProgress').style.display = 'block';
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('uploadFileModal')).hide();
                fileInput.value = '';
                document.getElementById('uploadProgress').style.display = 'none';
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al subir los archivos');
            });
        }
        
        // Formatear tama√±o
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '-';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        // Actualizar breadcrumbs din√°micamente
        function updateBreadcrumbs(nodoId) {
            console.log('üçû [BREADCRUMBS] Actualizando para nodoId:', nodoId);
            
            if (!nodoId) {
                console.log('üçû [BREADCRUMBS] NodoId es null - mostrando solo ra√≠z');
                // Limpiar breadcrumbs din√°micos (solo mostrar hasta "Contenido")
                const breadcrumbNav = document.getElementById('breadcrumbNav');
                const dinamicBreadcrumbs = breadcrumbNav.querySelectorAll('.breadcrumb-dynamic');
                dinamicBreadcrumbs.forEach(el => el.remove());
                return;
            }
            
            // Obtener ruta del backend
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}/path`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üçû [BREADCRUMBS] Datos recibidos:', data);
                    
                    if (!data.success || !data.path) {
                        console.error('üçû [BREADCRUMBS] Error en respuesta:', data);
                        return;
                    }
                    
                    const breadcrumbNav = document.getElementById('breadcrumbNav');
                    
                    // Eliminar breadcrumbs din√°micos anteriores
                    const dinamicBreadcrumbs = breadcrumbNav.querySelectorAll('.breadcrumb-dynamic');
                    dinamicBreadcrumbs.forEach(el => el.remove());
                    
                    // Agregar nuevos breadcrumbs desde la ruta
                    data.path.forEach((node, index) => {
                        console.log(`üçû [BREADCRUMBS] Nivel ${index}: ${node.nombre} (ID: ${node.nodoId})`);
                        
                        // Agregar separador
                        const separator = document.createElement('span');
                        separator.className = 'breadcrumb-separator breadcrumb-dynamic';
                        separator.textContent = '/';
                        breadcrumbNav.appendChild(separator);
                        
                        // Agregar breadcrumb item
                        const breadcrumbItem = document.createElement('div');
                        breadcrumbItem.className = 'breadcrumb-item breadcrumb-dynamic';
                        
                        const isLast = index === data.path.length - 1;
                        
                        if (isLast) {
                            // √öltimo elemento: solo texto, sin link
                            const span = document.createElement('span');
                            span.style.color = 'var(--text-primary)';
                            span.style.fontWeight = '500';
                            span.textContent = node.nombre;
                            breadcrumbItem.appendChild(span);
                        } else {
                            // Elementos intermedios: clickeables
                            const link = document.createElement('a');
                            link.href = 'javascript:void(0)';
                            link.textContent = node.nombre;
                            link.onclick = () => {
                                console.log(`üçû [BREADCRUMBS] Click en "${node.nombre}" (ID: ${node.nodoId})`);
                                loadFiles(node.nodoId);
                                updateBreadcrumbs(node.nodoId);
                            };
                            breadcrumbItem.appendChild(link);
                        }
                        
                        breadcrumbNav.appendChild(breadcrumbItem);
                    });
                    
                    console.log('‚úÖ [BREADCRUMBS] Actualizaci√≥n completada');
                })
                .catch(error => {
                    console.error('üí• [BREADCRUMBS] Error obteniendo ruta:', error);
                });
        }
        
        // Seleccionar/deseleccionar items
        function toggleSelection(nodoId) {
            const index = selectedItems.indexOf(nodoId);
            if (index > -1) {
                selectedItems.splice(index, 1);
            } else {
                selectedItems.push(nodoId);
            }
            updateToolbar();
        }
        
        function updateToolbar() {
            document.getElementById('btnDownload').style.display = selectedItems.length > 0 ? 'inline-flex' : 'none';
            document.getElementById('btnDelete').style.display = selectedItems.length > 0 ? 'inline-flex' : 'none';
        }
        
        // Funciones de acciones (implementar)
        function openRenameModal(nodoId, currentName) {
            document.getElementById('renameNodoId').value = nodoId;
            document.getElementById('newName').value = currentName || '';
            new bootstrap.Modal(document.getElementById('renameModal')).show();
        }
        
        function renameItem() {
            const nodoId = document.getElementById('renameNodoId').value;
            const newName = document.getElementById('newName').value.trim();
            
            if (!newName) return;
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: newName })
            })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();
                loadFiles(currentParentId);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al renombrar');
            });
        }
        
        function downloadFile(nodoId) {
            window.open(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}/download`, '_blank');
        }
        
        function deleteFile(nodoId) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este elemento?')) return;
            
            fetch(`/api/repositories/${REPOSITORIO_ID}/files/${nodoId}`, {
                method: 'DELETE'
            })
            .then(() => loadFiles(currentParentId))
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar');
            });
        }
        /*]]>*/
    </script>
</body>
</html>


