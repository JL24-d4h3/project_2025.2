<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Repositorio - DevPortal</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/project-repository.css}">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" th:href="@{/img/favicon.ico}">
</head>
<body>
    <!-- Banner de Impersonaci√≥n -->
    <div th:replace="~{fragments/impersonation-banner :: impersonation-banner}"></div>

    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="repository-container">
        <!-- Header -->
        <header class="main-header">
            <div class="header-content">
                <nav class="breadcrumb-nav">
                    <a th:href="@{/devportal/{userRole}/{username}/dashboard(userRole=${userRole}, username=${username})}">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <a th:href="@{/devportal/{userRole}/{username}/repositories(userRole=${userRole}, username=${username})}">
                        Repositorios
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span th:if="${repositoryType == 'personal'}">Personal</span>
                    <span th:if="${repositoryType == 'colaborativo'}">Colaborativo</span>
                    <span th:unless="${repositoryType}">Repositorio</span>
                    <span class="breadcrumb-separator">/</span>
                    <span>Crear</span>
                </nav>
                
                <div class="header-actions">
                    <div class="user-info">
                        <img th:src="${user.fotoPerfil != null ? user.fotoPerfil : '/img/default-avatar.png'}" 
                             alt="Avatar" class="user-avatar">
                        <span th:text="${user.nombreUsuario}">Usuario</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Form Header -->
            <section class="form-header">
                <div class="form-title">
                    <h1>
                        <div class="icon">
                            <i class="fas fa-user" th:if="${repositoryType == 'personal'}"></i>
                            <i class="fas fa-users" th:if="${repositoryType == 'colaborativo'}"></i>
                            <i class="fas fa-code-branch" th:unless="${repositoryType}"></i>
                        </div>
                        <span th:if="${repositoryType == 'personal'}">Crear Repositorio Personal</span>
                        <span th:if="${repositoryType == 'colaborativo'}">Crear Repositorio Colaborativo</span>
                        <span th:unless="${repositoryType}">Crear Nuevo Repositorio</span>
                    </h1>
                    <p class="form-subtitle">
                        <span th:if="${repositoryType == 'personal'}">Crea un repositorio personal para tu trabajo individual.</span>
                        <span th:if="${repositoryType == 'colaborativo'}">Crea un repositorio colaborativo para trabajar en equipo.</span>
                        <span th:unless="${repositoryType}">Crea un nuevo repositorio para organizar tu c√≥digo y colaborar con tu equipo.</span>
                    </p>
                </div>
            </section>
            
            <!-- Repository Form -->
            <section class="form-section">
            <form th:action="@{/devportal/{userRole}/{username}/repositories/create(userRole=${userRole}, username=${username})}"
                method="post"
                class="repository-form">
                    
                    <!-- Hidden Field for Repository Type -->
                    <input type="hidden" name="tipoRepositorio" th:value="${repositoryType == 'colaborativo' ? 'COLABORATIVO' : 'PERSONAL'}" />
                    
                    <!-- Error Messages -->
                    <div class="alert alert-danger" th:if="${error}">
                        <i class="fas fa-exclamation-circle"></i>
                        <span th:text="${error}">Error message</span>
                    </div>
                    
                    <!-- Success Messages -->
                    <div class="alert alert-success" th:if="${success}">
                        <i class="fas fa-check-circle"></i>
                        <span th:text="${success}">Success message</span>
                    </div>
                    
                    <!-- Basic Information -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <h3>
                                <i class="fas fa-info-circle"></i>
                                Informaci√≥n B√°sica
                            </h3>
                            <p>Informaci√≥n fundamental sobre tu repositorio.</p>
                        </div>
                        
                        <div class="form-card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="nombreRepositorio">
                                        Nombre del repositorio <span class="required">*</span>
                                    </label>
                                    <input type="text" 
                                           id="nombreRepositorio" 
                                           name="nombreRepositorio" 
                                           class="form-control" 
                                           required 
                                           placeholder="Ingresa un nombre descriptivo">
                                    <div class="form-text">
                                        El nombre debe ser √∫nico y descriptivo para identificar f√°cilmente tu repositorio.
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Tipo de Repositorio</label>
                                    <div class="form-control-readonly">
                                        <span th:if="${repositoryType == 'colaborativo'}" class="repository-type">
                                            <i class="fas fa-users"></i>
                                            Colaborativo
                                        </span>
                                        <span th:unless="${repositoryType == 'colaborativo'}" class="repository-type">
                                            <i class="fas fa-user"></i>
                                            Personal
                                        </span>
                                    </div>
                                    <div class="form-text">
                                        Tipo seleccionado al crear el repositorio.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="descripcionRepositorio">Descripci√≥n</label>
                                <textarea id="descripcionRepositorio" 
                                          name="descripcionRepositorio" 
                                          class="form-control" 
                                          rows="4" 
                                          placeholder="Describe el prop√≥sito y contenido de tu repositorio..."></textarea>
                                <div class="form-text">
                                    Una buena descripci√≥n ayuda a otros a entender de qu√© trata tu repositorio.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team Selection (Only for COLABORATIVO repositories) -->
                    <div class="form-card" th:if="${repositoryType == 'colaborativo'}" id="teamSelectionSection">
                        <div class="form-card-header">
                            <h3>
                                <i class="fas fa-users"></i>
                                Asignaci√≥n de Equipos
                            </h3>
                            <p>Asigna equipos que tendr√°n acceso a este repositorio colaborativo.</p>
                        </div>
                        
                        <div class="form-card-body">
                            <div class="form-group">
                                <label class="form-label">
                                    Seleccionar Equipos (Opcional)
                                </label>
                                <div class="teams-list">
                                    <div th:each="equipo : ${equipos}" class="team-checkbox-item">
                                        <div class="checkbox-wrapper">
                                            <input type="checkbox" 
                                                   th:id="${'equipo_' + equipo.equipoId}" 
                                                   th:name="${'equipoIds'}" 
                                                   th:value="${equipo.equipoId}"
                                                   class="team-checkbox">
                                            <label th:for="${'equipo_' + equipo.equipoId}" class="team-label" th:text="${equipo.nombreEquipo}">
                                                Nombre Equipo
                                            </label>
                                        </div>
                                        <div class="permissions-dropdown" th:id="${'permisos_' + equipo.equipoId}" style="display: none;">
                                            <select th:name="${'privilegioEquipo_' + equipo.equipoId}" class="form-select form-select-sm">
                                                <option value="LECTOR" selected>Lector (solo lectura)</option>
                                                <option value="EDITOR">Editor (lectura y escritura)</option>
                                                <option value="ADMINISTRADOR">Administrador (gesti√≥n total)</option>
                                                <option value="PERSONALIZADO">Personalizado (permisos espec√≠ficos)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div th:if="${equipos.isEmpty()}" class="no-teams-message">
                                        <i class="fas fa-info-circle"></i>
                                        <span>No hay equipos disponibles. <a href="javascript:showCreateTeamModal()">Crear uno nuevo</a></span>
                                    </div>
                                </div>
                                <div class="form-text">
                                    Selecciona uno o m√°s equipos y asigna permisos a cada uno. Puedes asociar equipos despu√©s si lo prefieres.
                                </div>
                                <button type="button" class="btn btn-outline-primary mt-2" onclick="showCreateTeamModal()">
                                    <i class="fas fa-plus"></i>
                                    Crear Nuevo Equipo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <h3>
                                <i class="fas fa-cog"></i>
                                Configuraci√≥n
                            </h3>
                            <p>Configura la visibilidad y permisos de tu repositorio.</p>
                        </div>
                        
                        <div class="form-card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="visibilidadRepositorio">Visibilidad</label>
                                    <select id="visibilidadRepositorio" name="visibilidadRepositorio" class="form-select">
                                        <option value="PUBLICO">P√∫blico</option>
                                        <option value="PRIVADO" selected>Privado</option>
                                    </select>
                                    <div class="form-text">
                                        P√∫blico: visible para todos. Privado: solo para colaboradores autorizados.
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="categoriaId">Categor√≠a</label>
                                    <select id="categoriaId" name="categoriaId" class="form-select">
                                        <option value="">Seleccionar categor√≠a</option>
                                        <option th:each="categoria : ${categories}" 
                                                th:value="${categoria.idCategoria}"
                                                th:text="${categoria.nombreCategoria}">
                                            Categor√≠a
                                        </option>
                                    </select>
                                    <div class="form-text">
                                        Selecciona una categor√≠a para organizar mejor tu repositorio.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Project Association -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <h3>
                                <i class="fas fa-project-diagram"></i>
                                Vinculaci√≥n con Proyecto
                            </h3>
                            <p>Asocia tu repositorio con uno o m√°s proyectos existentes (opcional).</p>
                        </div>
                        
                        <div class="form-card-body">
                            <div class="form-group">
                                <label class="form-label">Proyectos</label>
                                <div class="form-text mb-3">
                                    Solo se muestran proyectos donde eres el propietario (creador). Puedes asociar este repositorio a uno o m√°s de tus proyectos.
                                </div>
                                
                                <!-- Lista de checkboxes de proyectos -->
                                <div class="projects-checkbox-list" th:if="${projects != null and !projects.isEmpty()}">
                                    <div class="form-check" th:each="proyecto : ${projects}">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               th:id="'proyecto_' + ${proyecto.proyecto_id}"
                                               name="proyectoIds" 
                                               th:value="${proyecto.proyecto_id}">
                                        <label class="form-check-label" th:for="'proyecto_' + ${proyecto.proyecto_id}">
                                            <strong th:text="${proyecto.nombre_proyecto}">Nombre del Proyecto</strong>
                                            <span class="text-muted d-block small" th:text="${proyecto.descripcion_proyecto}">Descripci√≥n</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Mensaje cuando no hay proyectos -->
                                <div class="alert alert-info" th:unless="${projects != null and !projects.isEmpty()}">
                                    <i class="fas fa-info-circle"></i>
                                    No tienes proyectos propios a√∫n. Puedes crear un proyecto primero y luego asociarlo a este repositorio.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="actions-left">
                            <a th:href="@{/devportal/{userRole}/{username}/repositories(userRole=${userRole}, username=${username})}" 
                               class="btn btn-secondary">
                                <i class="fas fa-times"></i>
                                Cancelar
                            </a>
                        </div>
                        
                        <div class="actions-right">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Crear Repositorio
                            </button>
                        </div>
                    </div>
                </form>
            </section>
        </main>
    </div>
    
    <!-- Create Team Modal -->
    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Crear Nuevo Equipo (Temporal)</h2>
                <button type="button" class="modal-close" onclick="closeCreateTeamModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Nota:</strong> Este equipo se crear√° autom√°ticamente cuando hagas clic en "Crear Repositorio". Si cancelas, no se guardar√° nada.
                </div>
                <form id="createTeamForm">
                    <div class="form-group">
                        <label class="form-label" for="teamName">Nombre del Equipo</label>
                        <input type="text" id="teamName" class="form-control" placeholder="Ej: Equipo Backend, Marketing, etc." required>
                        <div class="form-text">Proporciona un nombre descriptivo para el equipo.</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="teamDescription">Descripci√≥n</label>
                        <textarea id="teamDescription" class="form-control" placeholder="Describe el prop√≥sito del equipo..." rows="3"></textarea>
                        <div class="form-text">Opcional: Describe qu√© hace este equipo.</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="teamPermission">Permisos del Equipo en el Repositorio</label>
                        <select id="teamPermission" class="form-select">
                            <option value="LECTOR" selected>Lector (solo lectura)</option>
                            <option value="EDITOR">Editor (lectura y escritura)</option>
                            <option value="ADMINISTRADOR">Administrador (gesti√≥n total)</option>
                            <option value="PERSONALIZADO">Personalizado (permisos espec√≠ficos)</option>
                        </select>
                        <div class="form-text">Selecciona los permisos que tendr√° este equipo en el repositorio.</div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCreateTeamModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="addTeamToRepository()">Agregar Equipo a Repositorio</button>
            </div>
        </div>
    </div>
    
    <!-- Additional Styles for Form -->
    <style>
        .form-header {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-bottom: 2rem;
        }
        
        .form-title h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .form-subtitle {
            color: var(--text-secondary);
            margin: 0;
            font-size: 1.125rem;
        }
        
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .repository-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .form-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }
        
        .form-card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            background: var(--gray-50);
        }
        
        .form-card-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-card-header p {
            color: var(--text-secondary);
            margin: 0;
        }
        
        .form-card-body {
            padding: 2rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .form-row:last-child {
            margin-bottom: 0;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            position: sticky;
            bottom: 2rem;
        }
        
        .actions-left,
        .actions-right {
            display: flex;
            gap: 1rem;
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .required {
            color: var(--danger-color);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-control,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }
        
        .form-text {
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .form-control-readonly {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--gray-50);
            color: var(--text-primary);
        }
        
        .repository-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        /* Teams List Styles */
        .teams-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .team-checkbox-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            background: white;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            transition: all 0.2s;
        }

        .team-checkbox-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team-checkbox {
            width: 1.125rem;
            height: 1.125rem;
            accent-color: var(--primary-color);
            cursor: pointer;
            flex-shrink: 0;
        }

        .team-label {
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        .permissions-dropdown {
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .permissions-dropdown select {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }

        .no-teams-message {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .no-teams-message a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .no-teams-message a:hover {
            text-decoration: underline;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            width: 90%;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            font-weight: 300;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .alert-info {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.2);
            color: var(--primary-color);
        }
        
        /* Projects Checkbox List Styles */
        .projects-checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            padding: 1rem;
            background: var(--bg-light);
        }

        .projects-checkbox-list .form-check {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 0;
        }

        .projects-checkbox-list .form-check:last-child {
            border-bottom: none;
        }

        .projects-checkbox-list .form-check:hover {
            background: rgba(74, 144, 226, 0.05);
        }

        .projects-checkbox-list .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
            margin-top: 0.125rem;
            cursor: pointer;
        }

        .projects-checkbox-list .form-check-label {
            margin-left: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .projects-checkbox-list .form-check-label strong {
            display: block;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .projects-checkbox-list .form-check-label .text-muted {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 1rem;
            }
            
            .actions-left,
            .actions-right {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/project-repository.js}"></script>
    
    <script>
        // Almacenar equipos temporales creados durante el formulario
        let temporaryTeams = [];
        let nextTemporaryTeamId = -1;

        // Toggle permissions dropdown when checkbox is checked/unchecked
        document.querySelectorAll('.team-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const teamId = this.value;
                const permissionsDiv = document.getElementById('permisos_' + teamId);
                if (this.checked) {
                    permissionsDiv.style.display = 'block';
                } else {
                    permissionsDiv.style.display = 'none';
                }
            });
        });

        // Mostrar modal para crear equipo
        function showCreateTeamModal() {
            document.getElementById('createTeamModal').classList.add('active');
        }
        
        // Cerrar modal de crear equipo
        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').classList.remove('active');
            document.getElementById('createTeamForm').reset();
        }
        
        // Agregar equipo temporal al repositorio (sin guardar en BD)
        function addTeamToRepository() {
            const teamName = document.getElementById('teamName').value;
            const teamDescription = document.getElementById('teamDescription').value;
            const teamPermission = document.getElementById('teamPermission').value;
            
            if (!teamName.trim()) {
                alert('Por favor ingresa un nombre para el equipo');
                return;
            }
            
            // Crear ID temporal negativo para identificarlo
            const tempId = nextTemporaryTeamId--;
            
            // Guardar en array temporal
            const newTeam = {
                id: tempId,
                name: teamName,
                description: teamDescription,
                permission: teamPermission,
                isTemporary: true
            };
            temporaryTeams.push(newTeam);
            
            // Agregar a la UI
            const teamsList = document.querySelector('.teams-list');
            const newTeamItem = document.createElement('div');
            newTeamItem.className = 'team-checkbox-item';
            newTeamItem.id = 'team-item-' + tempId;
            newTeamItem.innerHTML = `
                <div class="checkbox-wrapper">
                    <input type="checkbox" 
                           id="equipo_${tempId}" 
                           name="equipoIds" 
                           value="${tempId}"
                           class="team-checkbox"
                           checked>
                    <label for="equipo_${tempId}" class="team-label">
                        ${teamName}
                        <span style="font-size: 0.85rem; color: #ff9800; margin-left: 0.5rem;">(Nuevo - se crear√° al guardar)</span>
                    </label>
                </div>
                <div class="permissions-dropdown" id="permisos_${tempId}" style="display: block;">
                    <select name="privilegioEquipo_${tempId}" class="form-select form-select-sm">
                        <option value="LECTOR" ${teamPermission === 'LECTOR' ? 'selected' : ''}>Lector (solo lectura)</option>
                        <option value="EDITOR" ${teamPermission === 'EDITOR' ? 'selected' : ''}>Editor (lectura y escritura)</option>
                        <option value="ADMINISTRADOR" ${teamPermission === 'ADMINISTRADOR' ? 'selected' : ''}>Administrador (gesti√≥n total)</option>
                        <option value="PERSONALIZADO" ${teamPermission === 'PERSONALIZADO' ? 'selected' : ''}>Personalizado (permisos espec√≠ficos)</option>
                    </select>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTemporaryTeam(${tempId})" style="margin-top: 0.5rem;">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            `;
            
            // Remover mensaje de "sin equipos" si existe
            const noTeamsMessage = teamsList.querySelector('.no-teams-message');
            if (noTeamsMessage) {
                noTeamsMessage.remove();
            }
            
            teamsList.appendChild(newTeamItem);
            
            // Agregar event listener al nuevo checkbox
            newTeamItem.querySelector('.team-checkbox').addEventListener('change', function() {
                const teamId = this.value;
                const permissionsDiv = document.getElementById('permisos_' + teamId);
                if (this.checked) {
                    permissionsDiv.style.display = 'block';
                } else {
                    permissionsDiv.style.display = 'none';
                }
            });
            
            closeCreateTeamModal();
            alert('Equipo agregado temporalmente. Se crear√° cuando guardes el repositorio.');
        }
        
        // Eliminar equipo temporal
        function removeTemporaryTeam(tempId) {
            // Remover del array
            temporaryTeams = temporaryTeams.filter(t => t.id !== tempId);
            
            // Remover del DOM
            const teamItem = document.getElementById('team-item-' + tempId);
            if (teamItem) {
                teamItem.remove();
            }
            
            // Si no hay m√°s equipos, mostrar mensaje
            const teamsList = document.querySelector('.teams-list');
            if (teamsList.children.length === 0) {
                const noTeamsMessage = document.createElement('div');
                noTeamsMessage.className = 'no-teams-message';
                noTeamsMessage.innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    <span>No hay equipos disponibles. <a href="javascript:showCreateTeamModal()">Crear uno nuevo</a></span>
                `;
                teamsList.appendChild(noTeamsMessage);
            }
        }
        
        // Guardar equipo temporal antes de crear el repositorio
        function saveTemporaryTeamsToForm() {
            const form = document.querySelector('.repository-form');
            
            console.log('üîç [saveTemporaryTeamsToForm] INICIANDO - Verificando equipos temporales');
            console.log('üîç [saveTemporaryTeamsToForm] temporaryTeams.length = ' + temporaryTeams.length);
            
            // OPCI√ìN 1: Si hay equipos en el array temporaryTeams (agregados v√≠a modal)
            if (temporaryTeams.length > 0) {
                console.log('‚úÖ [saveTemporaryTeamsToForm] RUTA 1: Usando array temporaryTeams');
                temporaryTeams.forEach((team, index) => {
                    // Input para el nombre del equipo
                    const nameInput = document.createElement('input');
                    nameInput.type = 'hidden';
                    nameInput.name = 'temporaryTeamName_' + index;
                    nameInput.value = team.name;
                    form.appendChild(nameInput);
                    
                    // Input para la descripci√≥n
                    const descInput = document.createElement('input');
                    descInput.type = 'hidden';
                    descInput.name = 'temporaryTeamDesc_' + index;
                    descInput.value = team.description;
                    form.appendChild(descInput);
                    
                    // Input para el permiso
                    const permInput = document.createElement('input');
                    permInput.type = 'hidden';
                    permInput.name = 'temporaryTeamPermission_' + index;
                    permInput.value = team.permission;
                    form.appendChild(permInput);
                });
                
                const countInput = document.createElement('input');
                countInput.type = 'hidden';
                countInput.name = 'temporaryTeamsCount';
                countInput.value = temporaryTeams.length;
                form.appendChild(countInput);
                console.log('‚úÖ [DEBUG] temporaryTeamsCount creado (array) con valor: ' + temporaryTeams.length);
            } else {
                console.log('‚úÖ [saveTemporaryTeamsToForm] RUTA 2: Escaneando checkboxes para IDs negativos');
                
                // OPCI√ìN 2: Contar equipos temporales bas√°ndose en los equipoIds negativos (seleccionados en checkboxes)
                const equipoIdsInputs = document.querySelectorAll('input[name="equipoIds"]');
                console.log('üîç [DEBUG] Checkboxes encontrados en el DOM: ' + equipoIdsInputs.length);
                
                let temporaryTeamIds = [];
                let temporaryTeamIndex = 0;
                
                equipoIdsInputs.forEach((input, idx) => {
                    const isChecked = input.checked;
                    const value = input.value;
                    const isNegative = parseInt(value) < 0;
                    console.log('üîç [DEBUG] Checkbox ' + idx + ': value=' + value + ', checked=' + isChecked + ', isNegative=' + isNegative);
                    
                    if (isChecked && isNegative) {
                        console.log('‚úÖ [DEBUG] ENCONTRADO equipo temporal SELECCIONADO: ID=' + value);
                        temporaryTeamIds.push(value);
                        
                        // Buscar el nombre y permisos del equipo
                        const teamItem = document.getElementById('team-item-' + value);
                        
                        if (teamItem) {
                            // Crear inputs con el nombre y descripci√≥n basados en el checkbox
                            const nameInput = document.createElement('input');
                            nameInput.type = 'hidden';
                            nameInput.name = 'temporaryTeamName_' + temporaryTeamIndex;
                            
                            // Extraer el nombre del texto visible del checkbox
                            const label = teamItem.querySelector('.team-label');
                            nameInput.value = label ? label.textContent.trim().replace(/\(Nuevo.*\)/, '').trim() : 'Equipo Temporal';
                            form.appendChild(nameInput);
                            
                            // Permiso
                            const permInput = document.createElement('input');
                            permInput.type = 'hidden';
                            permInput.name = 'temporaryTeamPermission_' + temporaryTeamIndex;
                            const permSelect = document.querySelector('select[name="privilegioEquipo_' + value + '"]');
                            permInput.value = permSelect ? permSelect.value : 'LECTOR';
                            form.appendChild(permInput);
                            
                            temporaryTeamIndex++;
                        }
                    }
                });
                
                console.log('üîç [DEBUG] Total de equipos temporales ENCONTRADOS: ' + temporaryTeamIds.length);
                
                if (temporaryTeamIds.length > 0) {
                    const countInput = document.createElement('input');
                    countInput.type = 'hidden';
                    countInput.name = 'temporaryTeamsCount';
                    countInput.value = temporaryTeamIds.length;
                    form.appendChild(countInput);
                    console.log('‚úÖ [DEBUG] temporaryTeamsCount CREADO (checkboxes) con valor: ' + temporaryTeamIds.length);
                } else {
                    console.log('‚ö†Ô∏è [DEBUG] No hay equipos temporales agregados');
                    const countInput = document.createElement('input');
                    countInput.type = 'hidden';
                    countInput.name = 'temporaryTeamsCount';
                    countInput.value = 0;
                    form.appendChild(countInput);
                }
            }
        }
        
        // Interceptar el env√≠o del formulario
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ [DOMContentLoaded] DOM listo - Registrando listener del formulario');
            const form = document.querySelector('.repository-form');
            if (!form) {
                console.error('‚ùå [FORM LISTENER] No se encontr√≥ el formulario con clase .repository-form');
                return;
            }
            
            form.addEventListener('submit', function(e) {
                console.log('üì§ [FORM SUBMIT] ¬°Evento submit disparado! Guardando equipos temporales');
                saveTemporaryTeamsToForm();
                console.log('üì§ [FORM SUBMIT] Finalizado saveTemporaryTeamsToForm()');
            });
            console.log('‚úÖ [FORM LISTENER] Listener registrado correctamente');
        });
    </script>    <!-- Chatbot Widget -->
    <div th:replace="~{fragments/chatbot-widget :: chatbot-widget}"></div>

</body>
</html>


