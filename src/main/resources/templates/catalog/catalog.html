<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de APIs - DevPortal</title>
    <link rel="shortcut icon" href="/img/logo-telito.png" type="image/x-icon">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/navbar.css}">

    <style>
        :root {
            --primary-color: #2596be;
            --primary-dark: #1e7a9a;
            --primary-light: #e3f2fd;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-light: #e0e0e0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.12);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        .catalog-container { 
            padding: 1.5rem; 
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .catalog-main { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        .catalog-header { 
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .breadcrumb { 
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .breadcrumb a { 
            color: var(--primary-color); 
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover {
            color: var(--primary-dark);
        }
        
        .page-title { 
            margin: 0; 
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .catalog-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
            align-items: start;
            min-height: calc(100vh - 200px); /* Altura mínima en lugar de fija */
            max-height: none;
        }

        .filters-sidebar {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            position: sticky;
            top: 1.5rem;
            max-height: calc(100vh - 3rem);
            overflow-y: auto;
            overflow-x: hidden;
            min-width: 0; /* Evita overflow */
        }

        .filters-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-section {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }

        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .filter-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .filter-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            min-width: 0; /* Evita overflow */
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0;
            font-size: 0.85rem;
            min-width: 0; /* Permite text truncate */
        }

        .filter-option label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .filter-option input[type="checkbox"] {
            margin: 0;
        }

        .filter-option label {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            flex: 1;
        }

        .filter-actions {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .apis-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 250px); /* Altura mínima para mostrar contenido */
        }

        .apis-grid { 
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            width: 100%;
            flex: 1;
            align-content: flex-start;
        }
        
        .api-card { 
            background: white; 
            border-radius: var(--radius-md); 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            padding: 1.25rem;
            transition: all 0.2s;
            flex: 0 1 calc(33.333% - 1rem);
            min-width: 300px;
            max-width: 400px;
            min-height: 200px;
            max-height: 280px;
            display: flex;
            flex-direction: column;
        }
        
        .api-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .api-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 1rem;
        }
        
        .api-title { 
            margin: 0; 
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            line-height: 1.4;
            flex: 1;
            margin-right: 1rem;
        }
        
        .api-status { 
            padding: 0.25rem 0.75rem; 
            border-radius: var(--radius-sm); 
            font-size: 0.75rem; 
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }
        
        .api-status.produccion { background: #e8f5e8; color: #2e7d32; }
        .api-status.qa { background: #fff3e0; color: #f57c00; }
        .api-status.deprecated { background: #ffebee; color: #d32f2f; }
        
        .api-description { 
            color: var(--text-secondary); 
            margin-bottom: 1rem;
            line-height: 1.4;
            font-size: 0.85rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .api-chips {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
        }

        .chip-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            min-width: fit-content;
            margin-right: 0.5rem;
        }

        .chip {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .chip.category {
            background: #e3f2fd;
            color: #1976d2;
        }

        .chip.tag {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .chip.version {
            background: #e8f5e8;
            color: #388e3c;
        }

        .api-footer {
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-light);
            margin-top: auto;
        }

        .doc-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .doc-link:hover {
            color: var(--primary-dark);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--primary-dark);
        }

        /* Estilos de paginación */
        .pagination-nav {
            margin-top: auto;
            padding: 1rem 0 0 0;
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .pagination-info {
            text-align: center;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .pagination {
            margin-bottom: 0;
        }

        .page-link {
            color: var(--primary-color);
            border: 1px solid var(--border-light);
            padding: 0.5rem 0.75rem;
            margin: 0 0.125rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .page-link:hover {
            color: var(--primary-dark);
            background-color: var(--hover-bg);
            border-color: var(--primary-color);
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .page-item.disabled .page-link {
            color: var(--text-muted);
            background-color: transparent;
            border-color: var(--border-light);
            cursor: not-allowed;
        }

        .btn-primary { 
            background: var(--primary-color); 
            border: 1px solid var(--primary-color);
            color: white; 
            padding: 0.5rem 1rem; 
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-secondary {
            background: #6c757d;
            border: 1px solid #6c757d;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .catalog-content {
                grid-template-columns: 1fr;
            }
            
            .filters-sidebar {
                position: static;
                max-height: none;
            }
            
            .apis-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .catalog-container {
                padding: 1rem;
            }
            
            .catalog-content {
                grid-template-columns: 1fr;
                height: auto;
                gap: 1rem;
            }
            
            .filters-sidebar {
                position: static;
                max-height: none;
                margin-bottom: 1rem;
            }
            
            .api-card {
                flex: 1 1 100%;
                min-width: unset;
            }
            
            .catalog-header {
                padding: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .filter-options {
                grid-template-columns: 1fr;
            }
            
            .api-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .api-title {
                margin-right: 0;
            }
            
            .api-status {
                align-self: flex-start;
            }
        }
    </style>
</head>

<body>
    <!-- Banner de Impersonación -->
    <div th:replace="~{fragments/impersonation-banner :: impersonation-banner}"></div>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="catalog-container">

        <main class="catalog-main">
            <!-- Header -->
            <header class="catalog-header">
                <nav class="breadcrumb">
                    <a th:href="@{'/devportal/' + ${role} + '/' + ${username} + '/dashboard'}">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <i class="fas fa-chevron-right text-muted"></i>
                    <a th:href="@{'/devportal/' + ${role} + '/' + ${username} + '/portal'}">APIs</a>
                    <i class="fas fa-chevron-right text-muted"></i>
                    <span class="text-muted">Catálogo</span>
                </nav>
                <h1 class="page-title">
                    <i class="fas fa-book-open"></i>
                    Catálogo de APIs
                </h1>
            </header>

            <!-- Content -->
            <div class="catalog-content">
                <!-- Sidebar de filtros -->
                <aside class="filters-sidebar">
                    <a th:href="@{'/devportal/' + ${role} + '/' + ${username} + '/portal'}" class="back-link">
                        <i class="fas fa-arrow-left"></i> Volver a APIs
                    </a>
                    
                    <h3 class="filters-title">
                        <i class="fas fa-filter"></i>
                        Filtros
                    </h3>

                    <form id="filtersForm" 
                          th:action="@{'/devportal/' + ${role} + '/' + ${username} + '/catalog'}"
                          method="get">
                        
                        <!-- Campo oculto para mantener la página al filtrar -->
                        <input type="hidden" name="page" value="0" />
                        
                        <!-- Botones de acción arriba -->
                        <div class="filter-actions mb-3">
                            <button type="submit" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-search"></i> Aplicar filtros
                            </button>
                            <a th:href="@{'/devportal/' + ${role} + '/' + ${username} + '/catalog'}"
                               class="btn btn-outline-secondary w-100">
                                <i class="fas fa-eraser"></i> Limpiar filtros
                            </a>
                        </div>
                        
                        <!-- Categorías -->
                        <div class="filter-section" th:if="${categorias != null and !#lists.isEmpty(categorias)}">
                            <h4 class="filter-section-title">Categorías</h4>
                            <div class="filter-options">
                                <div class="filter-option" th:each="cat, iStat : ${categorias}">
                                    <input type="checkbox"
                                           name="categorias"
                                           th:id="${'cat_' + iStat.index}"
                                           th:value="${cat.nombreCategoria}"
                                           th:checked="${param.categorias != null} ? ${#lists.contains(param.categorias, cat.nombreCategoria)} : false"
                                           class="form-check-input">
                                    <label th:for="${'cat_' + iStat.index}" th:text="${cat.nombreCategoria}" class="form-check-label">
                                        Categoría
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Etiquetas -->
                        <div class="filter-section" th:if="${etiquetas != null and !#lists.isEmpty(etiquetas)}">
                            <h4 class="filter-section-title">Etiquetas</h4>
                            <div class="filter-options">
                                <div class="filter-option" th:each="tag, iStat : ${etiquetas}">
                                    <input type="checkbox"
                                           name="etiquetas"
                                           th:id="${'tag_' + iStat.index}"
                                           th:value="${tag.nombreTag}"
                                           th:checked="${param.etiquetas != null} ? ${#lists.contains(param.etiquetas, tag.nombreTag)} : false"
                                           class="form-check-input">
                                    <label th:for="${'tag_' + iStat.index}" th:text="${tag.nombreTag}" class="form-check-label">
                                        Etiqueta
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Estados -->
                        <div class="filter-section">
                            <h4 class="filter-section-title">Estado</h4>
                            <div class="filter-options">
                                <div class="filter-option">
                                    <input type="checkbox"
                                           name="estados" 
                                           id="estado_prod" 
                                           value="PRODUCCION"
                                           th:checked="${param.estados != null} ? ${#lists.contains(param.estados, 'PRODUCCION')} : false"
                                           class="form-check-input">
                                    <label for="estado_prod" class="form-check-label">Producción</label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox"
                                           name="estados" 
                                           id="estado_qa" 
                                           value="QA"
                                           th:checked="${param.estados != null} ? ${#lists.contains(param.estados, 'QA')} : false"
                                           class="form-check-input">
                                    <label for="estado_qa" class="form-check-label">QA</label>
                                </div>
                                <div class="filter-option">
                                    <input type="checkbox"
                                           name="estados" 
                                           id="estado_dep" 
                                           value="DEPRECATED"
                                           th:checked="${param.estados != null} ? ${#lists.contains(param.estados, 'DEPRECATED')} : false"
                                           class="form-check-input">
                                    <label for="estado_dep" class="form-check-label">Deprecated</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </aside>

                <!-- Grid de APIs -->
                <section class="apis-content">
                    <!-- Grid de APIs -->
                    <div class="apis-grid" th:if="${apis != null and !#lists.isEmpty(apis)}">
                        <article class="api-card" th:each="api : ${apis}">
                            <div class="api-header">
                                <h2 class="api-title" th:text="${api.nombreApi}">Nombre de la API</h2>
                                <span class="api-status"
                                      th:text="${api.estadoApi != null ? api.estadoApi.name() : 'SIN ESTADO'}"
                                      th:classappend="${api.estadoApi != null ? api.estadoApi.name().toLowerCase() : ''}">
                                    PRODUCCIÓN
                                </span>
                            </div>

                            <p class="api-description" th:text="${api.descripcionApi}">
                                Descripción de la API…
                            </p>

                            <div class="api-chips">
                                <!-- Categorías - Con manejo defensivo -->
                                <div class="chip-group" th:if="${api.categorias}">
                                    <span class="chip-label">Categorías:</span>
                                    <span class="chip category" th:each="c : ${api.categorias}" th:text="${c.nombreCategoria}">
                                        Categoría
                                    </span>
                                </div>

                                <!-- Etiquetas - Con manejo defensivo -->
                                <div class="chip-group" th:if="${api.etiquetas}">
                                    <span class="chip-label">Etiquetas:</span>
                                    <span class="chip tag" th:each="t : ${api.etiquetas}" th:text="${t.nombreTag}">
                                        Etiqueta
                                    </span>
                                </div>

                                <!-- Versiones - Con manejo de errores -->
                                <div class="chip-group" th:if="${api.versiones}" th:with="versionesSize=${#arrays.length(api.versiones)}">
                                    <span class="chip-label" th:if="${versionesSize > 0}">Versiones:</span>
                                    <span class="chip version" th:each="v : ${api.versiones}" th:text="${v.numeroVersion}">
                                        v1.0
                                    </span>
                                </div>
                            </div>

                            <!-- Footer con link -->
                            <footer class="api-footer" th:with="latestVersion=${api.versiones != null and !#lists.isEmpty(api.versiones) ? api.versiones[0] : null}">
                                <a th:if="${latestVersion != null}"
                                   th:href="@{'/devportal/' + ${role} + '/' + ${username} + '/catalog/api-' + ${api.apiId} + '/v-' + ${latestVersion.numeroVersion}}" 
                                   class="doc-link">
                                    <i class="fas fa-book"></i>
                                    Ver documentación
                                </a>
                                <span th:if="${latestVersion == null}" class="text-muted">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Sin versiones disponibles
                                </span>
                            </footer>
                        </article>
                    </div>

                    <!-- Mensaje cuando no hay APIs -->
                    <div class="text-center py-5" th:if="${apis == null or #lists.isEmpty(apis)}">
                        <i class="fas fa-search text-muted mb-3" style="font-size: 3rem;"></i>
                        <h3 class="text-muted mb-2">No se encontraron APIs</h3>
                        <p class="text-muted">Prueba ajustando los filtros para encontrar más resultados.</p>
                    </div>

                    <!-- Paginación -->
                    <nav th:if="${totalPages > 1}" class="pagination-nav" aria-label="Paginación de APIs">
                        <div class="pagination-info">
                            <span th:text="'Mostrando ' + ${(currentPage * 9) + 1} + '-' + ${(currentPage * 9) + #lists.size(apis)} + ' de ' + ${totalElements} + ' APIs'">
                                Mostrando 1-9 de 18 APIs
                            </span>
                        </div>
                        <ul class="pagination justify-content-center">
                            <!-- Anterior -->
                            <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled'">
                                <a class="page-link" 
                                   th:href="${hasPrevious} ? @{'/devportal/' + ${role} + '/' + ${username} + '/catalog'(page=${currentPage - 1}, categorias=${param.categorias}, etiquetas=${param.etiquetas}, estados=${param.estados})} : '#'"
                                   th:attr="aria-disabled=${!hasPrevious} ? 'true' : 'false'">
                                    <i class="fas fa-chevron-left"></i> Anterior
                                </a>
                            </li>

                            <!-- Números de página -->
                            <th:block th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}">
                                <li class="page-item" th:classappend="${pageNum == currentPage} ? 'active'">
                                    <a class="page-link" 
                                       th:href="@{'/devportal/' + ${role} + '/' + ${username} + '/catalog'(page=${pageNum}, categorias=${param.categorias}, etiquetas=${param.etiquetas}, estados=${param.estados})}"
                                       th:text="${pageNum + 1}">1</a>
                                </li>
                            </th:block>

                            <!-- Siguiente -->
                            <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                                <a class="page-link" 
                                   th:href="${hasNext} ? @{'/devportal/' + ${role} + '/' + ${username} + '/catalog'(page=${currentPage + 1}, categorias=${param.categorias}, etiquetas=${param.etiquetas}, estados=${param.estados})} : '#'"
                                   th:attr="aria-disabled=${!hasNext} ? 'true' : 'false'">
                                    Siguiente <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </section>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div th:replace="~{fragments/chatbot-widget :: chatbot-widget}"></div>

</body>
</html>
