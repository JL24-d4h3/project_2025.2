<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Estilos adicionales para navbar SA */
        .dp-navbar {
            background: #fff !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e9ecef;
        }
        
        .dp-navbar .navbar-brand {
            font-weight: 700;
            color: #007bff !important;
        }
        
        .dp-navbar .nav-link {
            color: #6c757d !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }
        
        .dp-navbar .nav-link:hover,
        .dp-navbar .nav-link.active {
            color: #007bff !important;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
        }
        
        .content-after-navbar {
            margin-top: 0;
            padding-top: 0;
        }
    </style>
</head>
<body>
    <!-- Fragment del navbar para Super Administrador -->
    <div th:fragment="navbar-sa" id="teldev-navbar-container">
        <nav class="dp-navbar navbar navbar-expand-lg">
            <div class="container-fluid">
                <!-- Brand -->
                <a class="navbar-brand d-flex align-items-center gap-2" 
                   th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/dashboard-panel'">
                    <span class="fw-bold">TelDev</span>
                    <span class="badge bg-danger ms-2">Super Admin</span>
                </a>

                <!-- Mobile toggle button -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#saNavbar"
                        aria-controls="saNavbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Collapsible content -->
                <div class="collapse navbar-collapse" id="saNavbar">
                    <!-- Main navigation -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <!-- Dashboard Principal (Métricas) -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/dashboard-panel'"
                               th:classappend="${currentNavSection == 'dashboard-panel'} ? 'active' : ''">
                                <i class="fas fa-chart-line me-1"></i>
                                Dashboard
                            </a>
                        </li>

                        <!-- Gestionar Usuarios -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/manage-users'"
                               th:classappend="${currentNavSection == 'manage-users'} ? 'active' : ''">
                                <i class="fas fa-users me-1"></i>
                                Gestionar Usuarios
                            </a>
                        </li>

                        <!-- Gestionar Categorías -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/manage-categories'"
                               th:classappend="${currentNavSection == 'manage-categories'} ? 'active' : ''">
                                <i class="fas fa-tags me-1"></i>
                                Gestionar Categorías
                            </a>
                        </li>

                        <!-- Impersonar Usuario -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/impersonate-user'"
                               th:classappend="${currentNavSection == 'impersonate-user'} ? 'active' : ''">
                                <i class="fas fa-user-secret me-1"></i>
                                Impersonar Usuario
                            </a>
                        </li>
                    </ul>

                    <!-- Right side navigation -->
                    <ul class="navbar-nav mb-2 mb-lg-0 align-items-lg-center">
                        <!-- Notifications -->
                        <li class="nav-item dropdown me-2">
                            <a class="nav-link position-relative" href="#" id="notificationsDropdown" 
                               role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-bell"></i>
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    3
                                    <span class="visually-hidden">notificaciones no leídas</span>
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end notifications-dropdown">
                                <li class="dropdown-header d-flex justify-content-between align-items-center">
                                    <span>Notificaciones del Sistema</span>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item notification-item" href="#">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-2">
                                                <div class="notification-title">Alerta del Sistema</div>
                                                <div class="notification-text">Alto uso de CPU detectado</div>
                                                <small class="text-muted">Hace 10 min</small>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item notification-item" href="#">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-user-plus text-success"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-2">
                                                <div class="notification-title">Nuevos usuarios</div>
                                                <div class="notification-text">5 usuarios registrados hoy</div>
                                                <small class="text-muted">Hace 1 hora</small>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-center" href="/sa/notificaciones">Ver todas las notificaciones</a></li>
                            </ul>
                        </li>

                        <!-- Stop Impersonation Button (only visible during impersonation) -->
                        <li class="nav-item me-2" id="stopImpersonationBtn" style="display: none;">
                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                    title="Dejar de Impersonar Usuario"
                                    onclick="stopImpersonation()">
                                <i class="fas fa-user-times me-1"></i>
                                <span class="d-none d-md-inline">Dejar de Impersonar</span>
                            </button>
                        </li>

                        <!-- User menu -->
                        <li class="nav-item dropdown">
                            <a class="nav-link d-flex align-items-center gap-2" href="#" 
                               id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <!-- Imagen real (oculta inicialmente) -->
                                <img class="rounded-circle border border-2 sa-profile-pic d-none" 
                                     th:src="@{/devportal/sa/{username}/profile/photo(username=${currentUser != null ? currentUser.username : username})}" 
                                     alt="Avatar" width="36" height="36" style="object-fit: cover;">
                                <!-- Icono por defecto (visible inicialmente) -->
                                <div class="d-flex align-items-center justify-content-center rounded-circle border border-2 bg-primary text-white sa-profile-default"
                                     style="width: 36px; height: 36px; flex-shrink: 0;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span class="d-none d-md-inline" 
                                      th:text="${currentUser != null ? currentUser.username : username}">username</span>
                                <i class="fas fa-chevron-down d-none d-md-inline"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                                <li class="dropdown-header">
                                    <div class="d-flex align-items-center">
                                        <!-- Imagen real (oculta inicialmente) -->
                                        <img class="rounded-circle me-2 sa-profile-pic-dropdown d-none" 
                                             th:src="@{/devportal/sa/{username}/profile/photo(username=${currentUser != null ? currentUser.username : username})}" 
                                             alt="Avatar" width="45" height="45" style="object-fit: cover;">
                                        <!-- Icono por defecto (visible inicialmente) -->
                                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary text-white me-2 sa-profile-default-dropdown"
                                             style="width: 45px; height: 45px; flex-shrink: 0;">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold" 
                                                 th:text="${currentUser != null ? currentUser.nombreUsuario + ' ' + currentUser.apellidoPaterno : 'Super Admin'}">Super Admin</div>
                                            <small class="text-muted">Administrador del Sistema</small>
                                        </div>
                                    </div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Profile section -->
                                <li class="dropdown-header small text-uppercase">Perfil</li>
                                <li>
                                    <a class="dropdown-item" th:href="@{/devportal/sa/{username}/profile(username=${username})}">
                                        <i class="fas fa-user me-2"></i>Mi Perfil
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="fas fa-cog me-2"></i>Configuración
                                    </a>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Quick actions -->
                                <li class="dropdown-header small text-uppercase">Acciones Rápidas</li>
                                <li>
                                    <a class="dropdown-item" 
                                       th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/create-new-user'">
                                        <i class="fas fa-user-plus me-2"></i>Crear Usuario
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" 
                                       th:href="'/devportal/sa/' + ${currentUser != null ? currentUser.username : 'admin'} + '/dashboard-panel'">
                                        <i class="fas fa-chart-line me-2"></i>Ver Métricas
                                    </a>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Help & Support -->
                                <li>
                                    <a class="dropdown-item" href="/help">
                                        <i class="fas fa-question-circle me-2"></i>Ayuda
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/foro/ver-foro">
                                        <i class="fas fa-comments me-2"></i>Foro
                                    </a>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Logout -->
                                <li>
                                    <form th:action="@{/auth/logout}" method="post" class="d-inline">
                                        <button class="dropdown-item text-danger" type="submit">
                                            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>

    <!-- Scripts específicos para SA navbar -->
    <script th:fragment="navbar-sa-scripts">
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar impersonación
            checkImpersonationStatus();
            
            // Configurar notificaciones
            setupNotifications();
            
            // Configurar navegación activa con delay
            setTimeout(setupActiveNavigation, 200);
        });

        // También ejecutar cuando se cambie la URL
        window.addEventListener('popstate', function() {
            setTimeout(setupActiveNavigation, 200);
        });

        function checkImpersonationStatus() {
            // Comentado temporalmente - funcionalidad de impersonación no implementada completamente
            /*
            fetch('/devportal/sa/impersonation-status')
                .then(response => response.json())
                .then(data => {
                    if (data.isImpersonating) {
                        document.getElementById('stopImpersonationBtn').style.display = 'block';
                        document.body.classList.add('impersonation-active');
                    }
                })
                .catch(error => {
                    console.log('No hay impersonación activa:', error);
                });
            */
        }

        function stopImpersonation() {
            if (confirm('¿Estás seguro que deseas dejar de impersonar este usuario?')) {
                fetch('/devportal/sa/exit-impersonation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Impersonación finalizada exitosamente.');
                        window.location.href = data.redirectUrl || '/sa/dashboard';
                    } else {
                        alert('Error al finalizar la impersonación: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexión al finalizar la impersonación');
                });
            }
        }

        function setupNotifications() {
            // Cargar notificaciones al hacer clic en el dropdown
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            if (notificationsDropdown) {
                notificationsDropdown.addEventListener('click', function() {
                    // TODO: Cargar notificaciones dinámicamente
                    console.log('Cargando notificaciones del sistema...');
                });
            }
        }

        function setupActiveNavigation() {
            // Marcar navegación activa basada en la URL actual
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link:not(.dropdown-toggle)');
            
            // Limpiar clases active primero
            navLinks.forEach(link => {
                link.classList.remove('active');
                link.parentElement.classList.remove('active');
            });
            
            // Definir patrones de rutas para cada sección
            const routePatterns = {
                'dashboard-panel': ['/dashboard-panel', '/dashboard'],
                users: ['/manage-users', '/gestionar-usuarios', '/create-new-user', '/crear-nuevo-usuario', '/invite-new-user', '/invitar-usuario'],
                categories: ['/manage-categories', '/gestionar-categorias'],
                impersonate: ['/impersonate-user', '/impersonar-usuario']
            };
            
            // Buscar y marcar el enlace activo
            let foundMatch = false;
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !foundMatch) {
                    const normalizedHref = href.split('?')[0].split('#')[0];
                    const normalizedCurrentPath = currentPath.split('?')[0].split('#')[0];
                    
                    // Verificar coincidencia exacta
                    if (normalizedCurrentPath === normalizedHref) {
                        link.classList.add('active');
                        foundMatch = true;
                        return;
                    }
                    
                    // Verificar patrones de ruta
                    for (const [section, patterns] of Object.entries(routePatterns)) {
                        const currentPathMatchesSection = patterns.some(pattern => 
                            normalizedCurrentPath.includes(pattern)
                        );
                        const linkMatchesSection = patterns.some(pattern => 
                            normalizedHref.includes(pattern)
                        );
                        
                        if (currentPathMatchesSection && linkMatchesSection && !foundMatch) {
                            link.classList.add('active');
                            foundMatch = true;
                            return;
                        }
                    }
                }
            });
        }

        // Manejar la carga de imágenes de perfil
        document.addEventListener('DOMContentLoaded', function() {
            // Para el navbar principal
            const profilePic = document.querySelector('.sa-profile-pic');
            const profileDefault = document.querySelector('.sa-profile-default');
            
            if (profilePic && profileDefault) {
                // Función para mostrar la imagen si se carga correctamente
                function showProfileImage() {
                    profilePic.classList.remove('d-none');
                    profilePic.classList.add('d-block');
                    profileDefault.classList.add('d-none');
                    profileDefault.classList.remove('d-flex');
                }
                
                // Función para mantener el icono por defecto
                function showDefaultIcon() {
                    profilePic.classList.add('d-none');
                    profilePic.classList.remove('d-block');
                    profileDefault.classList.remove('d-none');
                    profileDefault.classList.add('d-flex');
                }
                
                // Si la imagen ya está cargada (ej: en caché)
                if (profilePic.complete) {
                    if (profilePic.naturalHeight !== 0) {
                        // Imagen válida
                        showProfileImage();
                    } else {
                        // Imagen inválida o no existe
                        showDefaultIcon();
                    }
                } else {
                    // Agregar listeners para carga futura
                    profilePic.addEventListener('load', function() {
                        if (this.naturalHeight !== 0) {
                            showProfileImage();
                        }
                    });
                    profilePic.addEventListener('error', showDefaultIcon);
                }
            }
            
            // Para el dropdown
            const profilePicDropdown = document.querySelector('.sa-profile-pic-dropdown');
            const profileDefaultDropdown = document.querySelector('.sa-profile-default-dropdown');
            
            if (profilePicDropdown && profileDefaultDropdown) {
                // Función para mostrar la imagen si se carga correctamente
                function showDropdownImage() {
                    profilePicDropdown.classList.remove('d-none');
                    profilePicDropdown.classList.add('d-block');
                    profileDefaultDropdown.classList.add('d-none');
                    profileDefaultDropdown.classList.remove('d-flex');
                }
                
                // Función para mantener el icono por defecto
                function showDropdownDefault() {
                    profilePicDropdown.classList.add('d-none');
                    profilePicDropdown.classList.remove('d-block');
                    profileDefaultDropdown.classList.remove('d-none');
                    profileDefaultDropdown.classList.add('d-flex');
                }
                
                // Si la imagen ya está cargada (ej: en caché)
                if (profilePicDropdown.complete) {
                    if (profilePicDropdown.naturalHeight !== 0) {
                        // Imagen válida
                        showDropdownImage();
                    } else {
                        // Imagen inválida o no existe
                        showDropdownDefault();
                    }
                } else {
                    // Agregar listeners para carga futura
                    profilePicDropdown.addEventListener('load', function() {
                        if (this.naturalHeight !== 0) {
                            showDropdownImage();
                        }
                    });
                    profilePicDropdown.addEventListener('error', showDropdownDefault);
                }
            }
        });
    </script>
</body>
</html>


