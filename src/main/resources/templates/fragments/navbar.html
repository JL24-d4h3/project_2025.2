<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Fragment del navbar dinámico para todos los roles -->
    <div th:fragment="navbar" id="teldev-navbar-container">
        <!-- Top navbar - Brand y controles de usuario -->
        <nav class="dp-navbar-top">
            <div class="container-fluid">
                <!-- Brand -->
                <a class="navbar-brand d-flex align-items-center gap-2"
                   th:href="@{/devportal/{rol}/{username}/dashboard(rol=${rol}, username=${username})}">
                    <span class="fw-bold">TelDev</span>
                    <span class="badge badge-role ms-2" 
                          th:classappend="${rol == 'po'} ? 'bg-primary' : (${rol == 'qa'} ? 'bg-warning' : 'bg-success')"
                          th:text="${#strings.toUpperCase(rol == 'po' ? 'Product Owner' : (rol == 'qa' ? 'Quality Assurance' : 'Desarrollador'))}">ROL</span>
                </a>

                <!-- Right side controls -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Search bar - Desktop -->
                    <form class="dp-search d-none d-md-flex" role="search">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input class="form-control dp-search-input border-start-0" 
                                   type="search" 
                                   placeholder="Buscar..."
                                   id="globalSearch">
                        </div>
                    </form>

                    <!-- Notifications -->
                    <div class="dropdown">
                        <a class="nav-link-icon position-relative" href="#" id="notificationsDropdown" 
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end notifications-dropdown">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span>Notificaciones</span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item notification-item" href="#">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-user-plus text-success"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-2">
                                            <div class="notification-title">Nuevo usuario registrado</div>
                                            <div class="notification-text">Juan Pérez se registró en la plataforma</div>
                                            <small class="text-muted">Hace 5 min</small>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-center" href="#">Ver todas las notificaciones</a></li>
                        </ul>
                    </div>

                    <!-- Stop Impersonation Button -->
                    <div id="stopImpersonationBtn" style="display: none;">
                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                title="Dejar de Impersonar Usuario"
                                onclick="stopImpersonation()">
                            <i class="fas fa-user-times"></i>
                        </button>
                    </div>

                    <!-- User menu -->
                    <div class="dropdown">
                        <a class="nav-link-user d-flex align-items-center gap-2" href="#" 
                           id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img class="rounded-circle" 
                                 th:src="${currentUser != null and currentUser.fotoPerfil != null ? currentUser.fotoPerfil : '/img/default-avatar.png'}" 
                                 alt="Avatar" width="32" height="32">
                            <span class="d-none d-lg-inline user-name" 
                                  th:text="${currentUser != null ? currentUser.username : 'Usuario'}">Usuario</span>
                            <i class="fas fa-chevron-down d-none d-lg-inline"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                            <li class="dropdown-header">
                                <div class="d-flex align-items-center">
                                    <img class="rounded-circle me-2" 
                                         th:src="${currentUser != null and currentUser.fotoPerfil != null ? currentUser.fotoPerfil : '/img/default-avatar.png'}" 
                                         alt="Avatar" width="40" height="40">
                                    <div>
                                        <div class="fw-semibold" 
                                             th:text="${currentUser != null ? currentUser.nombreUsuario + ' ' + currentUser.apellidoPaterno : 'Usuario Nombre'}">Usuario Nombre</div>
                                        <small class="text-muted" 
                                               th:text="${currentUser != null ? '@' + currentUser.username : '@usuario'}">@usuario</small>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" 
                                   th:href="@{/devportal/{rol}/{username}/profile(rol=${rol}, username=${username})}">
                                    <i class="fas fa-user me-2"></i>Mi Perfil
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" 
                                   th:href="@{/devportal/{rol}/{username}/settings(rol=${rol}, username=${username})}">
                                    <i class="fas fa-cog me-2"></i>Configuración
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/auth/logout}" method="post" class="d-inline">
                                    <button class="dropdown-item text-danger" type="submit">
                                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>

                    <!-- Mobile menu toggle -->
                    <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#mainNavbar" aria-controls="mainNavbar" 
                            aria-expanded="false" aria-label="Toggle navigation">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Bottom navbar - Navegación principal -->
        <nav class="dp-navbar-bottom">
            <div class="container-fluid">
                <!-- Collapsible content -->
                <div class="collapse navbar-collapse d-lg-block" id="mainNavbar">
                    <!-- Main navigation -->
                    <ul class="navbar-nav d-flex flex-row mb-2 mb-lg-0">
                        <!-- Dashboard -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/dashboard(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'dashboard'} ? 'active' : ''"
                               data-label="Dashboard">
                                <i class="fas fa-box"></i>
                                <span class="nav-text">Dashboard</span>
                            </a>
                        </li>

                        <!-- User Management - Solo visible para Product Owners -->
                        <li class="nav-item" th:if="${rol == 'po'}">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/platform-user-management(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'platform-user-management'} ? 'active' : ''"
                               data-label="Usuarios">
                                <i class="fas fa-users"></i>
                                <span class="nav-text">Usuarios</span>
                            </a>
                        </li>

                        <!-- Teams -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/teams(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'teams'} ? 'active' : ''"
                               data-label="Equipos">
                                <i class="fas fa-people-group"></i>
                                <span class="nav-text">Equipos</span>
                            </a>
                        </li>

                        <!-- Catalogo -->
                        <li class="nav-item">
                            <a class="nav-link"
                               th:href="@{/devportal/{rol}/{username}/catalog(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'catalog'} ? 'active' : ''"
                               data-label="Catálogo">
                                <i class="fas fa-book"></i>
                                <span class="nav-text">Catálogo</span>
                            </a>
                        </li>

                        <!-- API -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/apis(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'apis'} ? 'active' : ''"
                               data-label="APIs">
                                <i class="fas fa-code"></i>
                                <span class="nav-text">APIs</span>
                            </a>
                        </li>


                        <!-- Projects -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/projects(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'projects'} ? 'active' : ''"
                               data-label="Proyectos">
                                <i class="fas fa-project-diagram"></i>
                                <span class="nav-text">Proyectos</span>
                            </a>
                        </li>

                        <!-- Repositories -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/repositories(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'repositories'} ? 'active' : ''"
                               data-label="Repositorios">
                                <i class="fab fa-git-alt"></i>
                                <span class="nav-text">Repositorios</span>
                            </a>
                        </li>
                        
                        <!-- Testing Environment -->
                        <li class="nav-item">
                            <a class="nav-link" 
                               th:href="@{/devportal/{rol}/{username}/test-environment(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'test-environment'} ? 'active' : ''"
                               data-label="Entorno de pruebas">
                                <i class="fas fa-cube"></i>
                                <span class="nav-text">Entorno de pruebas</span>
                            </a>
                        </li>

                        <!-- Tickets -->
                        <li class="nav-item">
                            <a class="nav-link"
                               th:href="@{/devportal/{rol}/{username}/tickets(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'tickets'} ? 'active' : ''"
                               data-label="Tickets">
                                <i class="fas fa-ticket-alt"></i>
                                <span class="nav-text">Tickets</span>
                            </a>
                        </li>

                        <!-- Reports & Analytics -->
                        <li class="nav-item">
                            <a class="nav-link"
                               th:href="@{/devportal/{rol}/{username}/reports(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'reports'} ? 'active' : ''"
                               data-label="Reportes">
                                <i class="fas fa-clipboard"></i>
                                <span class="nav-text">Reportes</span>
                            </a>
                        </li>

                        <!-- Feedbacks -->
                        <li class="nav-item">
                            <a class="nav-link"
                               th:href="@{/devportal/{rol}/{username}/feedback(rol=${rol}, username=${username})}"
                               th:classappend="${currentNavSection == 'feedback'} ? 'active' : ''"
                               data-label="Feedbacks">
                                <i class="fas fa-comment-dots"></i>
                                <span class="nav-text">Feedbacks</span>
                            </a>
                        </li>

                        <!-- Monitoreo -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="reportsDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               data-label="Monitoreo">
                                <i class="fas fa-chart-line"></i>
                                <span class="nav-text">Monitoreo</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item"
                                       th:href="@{/devportal/{rol}/{username}/reports/performance(rol=${rol}, username=${username})}">
                                    <i class="fas fa-chart-line me-2"></i>Performance
                                </a></li>
                                <li><a class="dropdown-item"
                                       th:href="@{/devportal/{rol}/{username}/reports/usage(rol=${rol}, username=${username})}">
                                    <i class="fas fa-chart-pie me-2"></i>Uso de APIs
                                </a></li>
                                <li><a class="dropdown-item"
                                       th:href="@{/devportal/{rol}/{username}/reports/projects(rol=${rol}, username=${username})}">
                                    <i class="fas fa-project-diagram me-2"></i>Estado de Proyectos
                                </a></li>
                            </ul>
                        </li>
                    </ul>
<!--                    &lt;!&ndash; Search bar &ndash;&gt;-->
<!--                    <form class="dp-search d-none d-lg-flex me-3" role="search">-->
<!--                        <div class="input-group">-->
<!--                            <span class="input-group-text bg-transparent border-end-0">-->
<!--                                <i class="fas fa-search text-muted"></i>-->
<!--                            </span>-->
<!--                            <input class="form-control dp-search-input border-start-0" -->
<!--                                   type="search" -->
<!--                                   placeholder="Buscar proyectos, APIs, usuarios..."-->
<!--                                   id="globalSearch">-->
<!--                        </div>-->
<!--                    </form>-->

                    <!-- Right side navigation -->
                </div>
            </div>
        </nav>
    </div>

    <!-- Scripts específicos para el navbar dinámico -->
    <script th:fragment="navbar-scripts">
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar impersonación
            checkImpersonationStatus();
            
            // Configurar búsqueda global
            setupGlobalSearch();
            
            // Configurar notificaciones
            setupNotifications();
        });

        function checkImpersonationStatus() {
            fetch('/impersonacion/check-status')
                .then(response => response.json())
                .then(data => {
                    if (data.isImpersonating) {
                        document.getElementById('stopImpersonationBtn').style.display = 'block';
                        document.body.classList.add('impersonation-active');
                    }
                })
                .catch(error => {
                    console.log('No hay impersonación activa:', error);
                });
        }

        function stopImpersonation() {
            if (confirm('¿Estás seguro que deseas dejar de impersonar este usuario?')) {
                fetch('/impersonacion/finalizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Impersonación finalizada exitosamente.');
                        window.location.href = data.redirectUrl;
                    } else {
                        alert('Error al finalizar la impersonación: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexión al finalizar la impersonación');
                });
            }
        }

        function setupGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                let searchTimeout;
                
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performGlobalSearch(this.value);
                    }, 300);
                });

                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performGlobalSearch(this.value);
                    }
                });
            }
        }

        function performGlobalSearch(query) {
            if (query.trim().length < 2) return;
            
            // Implementar búsqueda global aquí
            console.log('Buscando:', query);
            // TODO: Implementar llamada a API de búsqueda
        }

        function setupNotifications() {
            // Cargar notificaciones al hacer clic en el dropdown
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            if (notificationsDropdown) {
                notificationsDropdown.addEventListener('click', function() {
                    // TODO: Cargar notificaciones dinámicamente
                    console.log('Cargando notificaciones...');
                });
            }
        }
    </script>
</body>
</html>


